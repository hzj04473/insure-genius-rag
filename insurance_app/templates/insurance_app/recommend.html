{% extends "insurance_app/layouts/base.html" %}
{% load static %}

{% block title %}맞춤 보험 추천 - 스마트 보험료 계산기{% endblock %}

{% block extra_css %}
<style>
  /* 보험 추천 페이지 스타일 */
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-4);
  }
  .loading {
    display: none;
    text-align: center;
    padding: var(--spacing-10);
  }
  
  .spinner {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid var(--border-light);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .results {
    display: none;
  }
  .market-summary {
    background: var(--primary-color);
    color: white;
    padding: var(--spacing-6);
    border-radius: var(--radius-xl);
    margin-bottom: var(--spacing-6);
    text-align: center;
  }
  
  .quote-card {
    background: var(--bg-card);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-xl);
    padding: var(--spacing-6);
    margin: var(--spacing-5) 0;
    transition: var(--transition-normal);
    position: relative;
  }
  
  .quote-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-xl);
  }
  
  .quote-card.best {
    border-color: var(--secondary-color);
    background: linear-gradient(135deg, var(--secondary-50), var(--bg-card));
  }
  
  .best-badge {
    position: absolute;
    top: -10px;
    right: 20px;
    background: var(--secondary-color);
    color: white;
    padding: var(--spacing-2) var(--spacing-4);
    border-radius: var(--radius-full);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-bold);
  }
        .company-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .company-name { font-size: 1.5em; font-weight: bold; color: #2c3e50; }
        .premium-display { text-align: right; }
        .annual-premium { font-size: 2em; font-weight: bold; color: #e74c3c; }
        .monthly-premium { color: #666; font-size: 0.9em; }
        .quote-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .detail-section { background: #f8f9fa; padding: 15px; border-radius: 10px; }
        .detail-title { font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .coverage-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #e0e0e0; }
        .coverage-item:last-child { border-bottom: none; }
        .benefit-tag { display: inline-block; background: #3498db; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin: 2px; }
        .special-discount { background: #27ae60; color: white; padding: 10px; border-radius: 8px; margin: 10px 0; font-weight: bold; }
        .rating-display { display: flex; gap: 20px; margin-top: 15px; }
        .rating-item { text-align: center; }
        .rating-score { font-size: 1.2em; font-weight: bold; color: #f39c12; }
        .user-info-card { background: #e8f4f8; border: 2px solid #3498db; border-radius: 15px; padding: 20px; margin-bottom: 30px; }
        .back-link { text-align: center; margin-top: 30px; }
        .back-link a { color: #3498db; text-decoration: none; font-weight: bold; }
        .clause-search-section { background: #e7f1ff; border-radius: 15px; margin: 40px 0 0 0; padding: 30px; }
        .clause-search-results { margin-top: 20px; }
        .clause-result-card { background: #f3faff; border: 2px solid #c8e6ff; border-radius: 10px; padding: 20px; margin-bottom: 16px; }
        .clause-company { font-weight: bold; color: #2c3e50; }
        .clause-title { font-weight: bold; color: #2980b9; margin-bottom: 5px; }
        .clause-meta { font-size: 0.92em; color: #888; }
        .nav-bar { margin-top: 18px; display: flex; gap: 10px; justify-content: center; }
        .nav-btn { display: inline-block; background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 8px 18px;
                   border-radius: 30px; font-size: 1em; font-weight: 500; text-decoration: none; transition: background 0.2s, transform 0.2s; }
        .nav-btn:hover { background: linear-gradient(135deg, #2980b9, #3498db); transform: translateY(-2px) scale(1.04); }
        .logout-btn { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .logout-btn:hover { background: linear-gradient(135deg, #c0392b, #e74c3c); }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
  <!-- 페이지 헤더 -->
  <div class="card" style="margin-bottom: var(--spacing-6);">
    <div class="card-body" style="text-align: center;">
      <div style="width: 80px; height: 80px; background: var(--secondary-100); border-radius: var(--radius-2xl); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--spacing-4);">
        <span style="font-size: 40px;">💰</span>
      </div>
      <h1 style="font-size: var(--font-size-4xl); font-weight: var(--font-weight-extrabold); color: var(--text-primary); margin-bottom: var(--spacing-3);">
        스마트 보험료 계산기
      </h1>
      <p style="font-size: var(--font-size-lg); color: var(--text-secondary); margin-bottom: var(--spacing-4);">
        11개 주요 보험사 견적을 한 번에 비교하세요!
      </p>
      
      <div style="display: flex; gap: var(--spacing-3); justify-content: center; flex-wrap: wrap;">
        <a href="{% url 'insurance_app:insurance_recommendation' %}" class="btn btn-outline">🔍 AI 약관 검색</a>
        <a href="{% url 'insurance_app:glossary' %}" class="btn btn-outline">📘 용어 사전</a>
      </div>
    </div>
  </div>
  {% if user.is_authenticated %}
  <div class="card" style="margin-bottom: var(--spacing-6);">
    <div class="card-header">
      <h3 style="margin: 0; font-weight: var(--font-weight-bold);">👤 {{ user.username }}님의 기본 정보</h3>
    </div>
    <div class="card-body">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-4);">
        <div style="padding: var(--spacing-3); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
          <strong>생년월일:</strong> {{ user.birth_date|default:"미입력" }}
        </div>
        <div style="padding: var(--spacing-3); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
          <strong>성별:</strong> {{ user.get_gender_display|default:"미입력" }}
        </div>
        <div style="padding: var(--spacing-3); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
          <strong>운전면허:</strong> {% if user.has_license %}보유{% else %}미보유{% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="card" style="margin-bottom: var(--spacing-6);">
    <div class="card-header">
      <h3 style="margin: 0; font-weight: var(--font-weight-bold);">📋 보험료 계산을 위한 추가 정보</h3>
    </div>
    <div class="card-body">
      <form id="insuranceForm" method="post">
        {% csrf_token %}
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="region">거주 지역</label>
            <select id="region" name="region" class="form-input" required>
              {% for region in regions %}
                <option value="{{ region }}">{{ region }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="driving_experience">운전 경력 (년)</label>
            <input type="number" id="driving_experience" name="driving_experience" class="form-input" min="0" max="50" value="5" required>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="accident_history">사고 이력 (건)</label>
            <input type="number" id="accident_history" name="accident_history" class="form-input" min="0" max="10" value="0" required>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="annual_mileage">연간 주행거리 (km)</label>
            <input type="number" id="annual_mileage" name="annual_mileage" class="form-input" min="1000" max="50000" value="12000" required>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="car_type">차량 종류</label>
            <select id="car_type" name="car_type" class="form-input" required>
              {% for car_type in car_types %}
                <option value="{{ car_type }}">{{ car_type }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="coverage_level">보장 수준</label>
            <select id="coverage_level" name="coverage_level" class="form-input" required>
              {% for level in coverage_levels %}
                <option value="{{ level }}" {% if level == '표준' %}selected{% endif %}>{{ level }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        
        <div style="margin-top: var(--spacing-6);">
          <button type="submit" class="btn btn-primary btn-lg" id="calculateBtn">
            🔍 보험료 견적 받기
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <h3 style="color: var(--text-primary); margin: var(--spacing-4) 0;">11개 보험사 견적을 계산하고 있습니다...</h3>
    <p style="color: var(--text-secondary);">잠시만 기다려주세요. 최적의 보험료를 찾고 있어요! 💡</p>
  </div>

  <div id="results" class="results"></div>

            <!-- ======================== 약관 검색 추가 영역 ======================= -->
            <div class="clause-search-section">
                <h3>🔍 보험사별 약관 키워드 검색</h3>
                <form id="clauseSearchForm" style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                    <div style="flex:1; min-width: 220px;">
                        <label for="clauseQuery">검색어</label>
                        <input type="text" id="clauseQuery" name="clauseQuery" placeholder="예: 음주운전, 가족, 특약 등" style="width:100%; padding:12px; border-radius:8px;">
                    </div>
                    <div style="flex:1; min-width: 180px;">
                        <label for="clauseCompany">보험사 선택</label>
                        <select id="clauseCompany" name="clauseCompany" style="width:100%; padding:12px; border-radius:8px;">
                            <option value="">전체 보험사</option>
                            {% for comp in insurance_companies %}
                                <option value="{{ comp }}">{{ comp }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn" style="max-width:220px;">약관 검색</button>
                </form>
                <div id="clauseLoading" class="loading" style="padding: 16px 0;">
                    <div class="spinner"></div>
                    <p>약관을 검색하고 있습니다...</p>
                </div>
                <div class="clause-search-results" id="clauseResults"></div>
            </div>
            <!-- ======================== 약관 검색 추가 끝 ======================= -->
</div>
{% endblock %}

{% block extra_js %}
<script>
        console.log('보험 추천 JS 로딩');

        // ================== 보험료 견적 ==================
        document.getElementById('insuranceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const loadingDiv = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            const calculateBtn = document.getElementById('calculateBtn');
            loadingDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            calculateBtn.disabled = true;

            const formData = new FormData(this);
            try {
                const response = await fetch('{% url "recommend_insurance" %}', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
                });
                const data = await response.json();
                if (data.success) {
                    displayResults(data.data);
                } else {
                    alert('오류: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('견적 계산 중 오류가 발생했습니다.');
            } finally {
                loadingDiv.style.display = 'none';
                calculateBtn.disabled = false;
            }
        });

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            if (!data || !data.quotes || data.quotes.length === 0) {
                resultsDiv.innerHTML = '<div>결과가 없습니다.</div>';
                resultsDiv.style.display = 'block';
                return;
            }

            // ✅ 가성비최고 회사를 배열 맨 앞으로 이동
            if (data.market_analysis && data.market_analysis.best_value) {
                const best = data.quotes.find(q => q.company === data.market_analysis.best_value);
                if (best) {
                    data.quotes = [best, ...data.quotes.filter(q => q.company !== best.company)];
                }
            }

            let html = '';
            html += `
                <div class="user-info-card">
                    <h3>👤 개인 분석</h3>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
                        <div>연령대: ${data.user_info.age_category}</div>
                        <div>위험도: ${data.user_info.risk_level}</div>
                        <div>추천 보장: ${data.user_info.recommended_coverage}</div>
                    </div>
                </div>
            `;

            if (data.market_analysis) {
                html += `
                    <div class="market-summary">
                        <b>시장 분석</b><br>
                        최저 보험료: <b>${data.market_analysis.lowest_premium.toLocaleString()}원</b> /
                        최고: <b>${data.market_analysis.highest_premium.toLocaleString()}원</b> /
                        평균: <b>${data.market_analysis.average_premium.toLocaleString()}원</b> /
                        가성비 최고: <b>${data.market_analysis.best_value}</b>
                    </div>
                `;
            }

            data.quotes.forEach((q) => {
                const isBest = data.market_analysis && data.market_analysis.best_value === q.company;
                html += `
                <div class="quote-card${isBest ? ' best' : ''}">
                    ${isBest ? '<span class="best-badge">가성비최고</span>' : ''}
                    <div class="company-header">
                        <span class="company-name">${q.company}</span>
                        <div class="premium-display">
                            <span class="annual-premium">${q.annual_premium.toLocaleString()}원</span>
                            <div class="monthly-premium">(월 ${q.monthly_premium.toLocaleString()}원)</div>
                        </div>
                    </div>
                    <div class="quote-details">
                        <div class="detail-section">
                            <div class="detail-title">보장 내용</div>
                            ${Object.entries(q.coverage_details).map(([k, v]) =>
                                `<div class="coverage-item"><span>${k}</span><span>${v}</span></div>`).join('')}
                        </div>
                        <div class="detail-section">
                            <div class="detail-title">자기부담금</div>
                            ${Object.entries(q.deductible).map(([k, v]) =>
                                `<div class="coverage-item"><span>${k}</span><span>${Number(v).toLocaleString()}원</span></div>`).join('')}
                        </div>
                        <div class="detail-section">
                            <div class="detail-title">혜택/특전</div>
                            ${q.additional_benefits.map(b => `<span class="benefit-tag">${b}</span>`).join('')}
                            ${q.special_discount ? `<div class="special-discount">특별할인: ${q.special_discount}</div>` : ''}
                        </div>
                    </div>
                    <div class="rating-display">
                        <div class="rating-item">고객만족도<br><span class="rating-score">${q.customer_satisfaction}/5.0</span></div>
                        <div class="rating-item">클레임 서비스<br><span class="rating-score">${q.claim_service_rating}/5.0</span></div>
                        <div class="rating-item">경력 할인<br><span class="rating-score">${q.discount_rate}</span></div>
                        <div class="rating-item">사고 할증<br><span class="rating-score">${q.penalty_rate}</span></div>
                    </div>
                </div>
                `;
            });

            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // ============== Pinecone 약관 검색 ==============
        document.getElementById('clauseLoading').style.display = 'none';
        document.getElementById('clauseSearchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const query = document.getElementById('clauseQuery').value.trim();
            const company = document.getElementById('clauseCompany').value.trim();
            const loading = document.getElementById('clauseLoading');
            const resultArea = document.getElementById('clauseResults');
            if (!query) { alert('검색어를 입력해주세요.'); return; }
            loading.style.display = 'block';
            resultArea.innerHTML = '';
            try {
                const res = await fetch('/insurance-recommendation/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query, company, top_k: 12})
                });
                const data = await res.json();
                loading.style.display = 'none';

                if (data.success) {
                    const refs = (data.references || []).map((s,i) => {
                        const sc = typeof s.score==='number' ? ` (${(Math.max(0, Math.min(0.999, Number(s.score)||0))*100).toFixed(1)}%)` : '';
                        const file = s.file ? ` | ${s.file}` : '';
                        const page = s.page ? ` | p.${s.page}` : '';
                        return `(${i+1}) ${s.company||'?'}${file}${page}${sc}`;
                    }).join('<br/>') || '—';

                    resultArea.innerHTML = `
                        <div class="clause-result-card">
                            <div class="clause-title">요약 답변</div>
                            <div style="white-space:pre-wrap">${(data.answer||'').replace(/\n/g,'\n')}</div>
                            <div class="clause-meta" style="margin-top:10px">근거<br/>${refs}</div>
                        </div>
                    `;
                } else {
                    resultArea.innerHTML = '<div style="padding: 18px;">검색 결과가 없습니다.</div>';
                }
            } catch (error) {
                loading.style.display = 'none';
                resultArea.innerHTML = '<div style="padding: 18px;">검색 오류가 발생했습니다.</div>';
            }
        });
</script>
{% endblock %}
