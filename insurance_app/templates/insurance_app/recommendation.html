{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë³´í—˜ ì•½ê´€ RAG ì±—ë´‡</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><text y="1em" font-size="96">ğŸ¤–</text></svg>'>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1000px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden}
    .header{background:linear-gradient(135deg,#2c3e50,#3498db);color:#fff;padding:26px 30px;text-align:center}
    .header h1{font-size:2.2em;margin-bottom:8px;font-weight:300}
    .nav-bar{margin-top:12px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .nav-btn{display:inline-block;background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:8px 18px;border-radius:30px;font-size:1em;font-weight:500;text-decoration:none;transition:.2s;border:none;cursor:pointer}
    .nav-btn:hover{background:linear-gradient(135deg,#2980b9,#3498db);transform:translateY(-2px) scale(1.04)}
    .logout-btn{background:linear-gradient(135deg,#e74c3c,#c0392b)}
    .logout-btn:hover{background:linear-gradient(135deg,#c0392b,#e74c3c)}
    .content{padding:26px 30px 32px}
    .chat-wrap{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px}
    .chat-title{font-size:1.2em;font-weight:700;color:#2c3e50;margin-bottom:10px}
    .chat-box{max-height:560px;min-height:360px;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:14px;background:#fafafa}
    .msg{margin:10px 0;display:flex}
    .msg.user{justify-content:flex-end}
    .bubble{max-width:80%;padding:12px 14px;border-radius:14px;border:1px solid #e5e7eb;line-height:1.6}
    .msg.user .bubble{background:#e7f1ff;border-color:#cfe0ff}
    .msg.assistant .bubble{background:#f8f9fa}
    .meta{margin-top:8px;font-size:.85em;color:#6b7280}
    .typing{display:inline-flex;align-items:center;gap:8px}
    .dot{width:8px;height:8px;border-radius:50%;background:#9aa7b2;animation:bounce 1.2s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes bounce{0%,80%,100%{transform:scale(0.6);opacity:.5}40%{transform:scale(1);opacity:1}}
    .input-row{display:flex;gap:8px;margin-top:12px}
    .input{flex:1;border:2px solid #e0e0e0;border-radius:12px;padding:14px 16px;font-size:1em;outline:none}
    .send-btn{border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#3498db,#2980b9);color:#fff}
    .send-btn:disabled{opacity:.6;cursor:not-allowed}
    .examples{background:#e7f1ff;border-radius:12px;padding:16px;margin-top:16px}
    .examples h3{font-size:1.05em;margin-bottom:10px}
    .chip{display:inline-block;background:#fff;border:2px solid #3498db;color:#3498db;padding:8px 12px;margin:6px;border-radius:999px;cursor:pointer;font-weight:600}
    .chip:hover{background:#3498db;color:#fff}
    .footer{background:#2c3e50;color:#fff;text-align:center;padding:18px;font-size:.95em;opacity:.9}
    @media (max-width:768px){.container{margin:8px;border-radius:16px}.chat-box{min-height:300px}}
    mark{background:#fff2ac;padding:0 .2em;border-radius:.2em}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¤– ë³´í—˜ ì•½ê´€ RAG ì±—ë´‡</h1>
      <p>ìì—°ì–´ë¡œ ì§ˆë¬¸í•˜ë©´, ê´€ë ¨ ì•½ê´€ì„ ì°¾ì•„ ê·¼ê±°ì™€ í•¨ê»˜ ë‹µí•´ë“œë ¤ìš”.</p>
      <div class="nav-bar">
        {% if user.is_authenticated %}
          <form action="{% url 'logout' %}" method="post" style="display:inline;">{% csrf_token %}
            <button type="submit" class="nav-btn logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
          </form>
        {% endif %}
        <a href="{% url 'home' %}" class="nav-btn">í™ˆìœ¼ë¡œ</a>
      </div>
    </div>

    <div class="content">
      {% if user.is_authenticated %}
      <div style="background:#e8f4f8;border:2px solid #3498db;border-radius:12px;padding:14px;margin-bottom:14px">
        <strong>ğŸ‘¤ {{ user.username }}</strong>ë‹˜, ê¶ê¸ˆí•œ ì•½ê´€ì„ ë¬¼ì–´ë³´ì„¸ìš”.
      </div>
      {% endif %}

      <div class="chat-wrap">
        <div class="chat-title">ëŒ€í™”</div>
        <div id="chatBox" class="chat-box"></div>

        <div class="input-row">
          <input id="chatInput" class="input" type="text"
                 placeholder="ì˜ˆ) ìŒì£¼ìš´ì „ ì‚¬ê³  ì‹œ ë³´ìƒì—¬ë¶€ëŠ”? / ë¬´ì‚¬ê³  í• ì¸ ê¸°ì¤€ì€?"
                 onkeypress="if(event.key==='Enter'){sendChat()}">

          <select id="answerMode" class="input" style="max-width:160px;flex:0 0 160px">
            <option value="brief">ê°„ë‹¨</option>
            <option value="normal" selected>ìì„¸íˆ</option>
            <option value="clauses">ì¡°í•­ë§Œ</option>
          </select>

          <button id="chatSend" class="send-btn" onclick="sendChat()">ì§ˆë¬¸í•˜ê¸°</button>
        </div>
      </div>

      <div class="examples">
        <h3>ğŸ’¡ ì˜ˆì‹œ ì§ˆë¬¸</h3>
        <span class="chip" onclick="quickAsk('ìŒì£¼ìš´ì „ìœ¼ë¡œ ì‚¬ê³ ê°€ ë‚¬ì„ ë•Œ ë³´ìƒë˜ë‚˜ìš”?')">ìŒì£¼ìš´ì „ ë³´ìƒ ì—¬ë¶€</span>
        <span class="chip" onclick="quickAsk('ë¬´ì‚¬ê³  í• ì¸ì€ ì–´ë–»ê²Œ ì ìš©ë˜ë‚˜ìš”?')">ë¬´ì‚¬ê³  í• ì¸ ê¸°ì¤€</span>
        <span class="chip" onclick="quickAsk('ê°€ì¡± íŠ¹ì•½ í˜œíƒì€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?')">ê°€ì¡± íŠ¹ì•½</span>
        <span class="chip" onclick="quickAsk('ì°¨ëŸ‰ ë„ë‚œ ì‹œ ë³´ìƒ ê¸°ì¤€ì€?')">ë„ë‚œ ë³´ìƒ</span>
      </div>
    </div>
  </div>

  <div class="footer">
    <p>RAG + Pinecone ê¸°ë°˜ ì•½ê´€ ì±—ë´‡ â€” ì •í™•í•œ ê°€ì… ì „ ë°˜ë“œì‹œ ì›ë¬¸ ì•½ê´€ì„ í™•ì¸í•˜ì„¸ìš”.</p>
  </div>

  <script>
    // MEDIA_URL ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ëŠ” í™˜ê²½ ëŒ€ë¹„
    const MEDIA_BASE = "{{ MEDIA_URL|default:'/media/' }}";

    function getCookie(name){
      let v=null;
      if(document.cookie&&document.cookie!==''){
        const cookies=document.cookie.split(';');
        for(let i=0;i<cookies.length;i++){
          const c=cookies[i].trim();
          if(c.substring(0,name.length+1)===(name+'=')){ v=decodeURIComponent(c.substring(name.length+1));break; }
        }
      }
      return v;
    }

    const chatBox = document.getElementById('chatBox');

    function appendMsg(role, html, id=null){
      const wrap=document.createElement('div');
      wrap.className='msg '+role;
      const bubble=document.createElement('div');
      bubble.className='bubble';
      bubble.innerHTML=html;
      if(id) bubble.id=id;
      wrap.appendChild(bubble);
      chatBox.appendChild(wrap);
      chatBox.scrollTop=chatBox.scrollHeight;
    }

    function addThinkingBubble(){
      const id='pending-'+Date.now();
      const html=`<div class="typing"><span>ê´€ë ¨ ì•½ê´€ì„ ì°¾ëŠ” ì¤‘ì´ì—ìš”...</span>
        <span class="dot"></span><span class="dot"></span><span class="dot"></span></div>`;
      appendMsg('assistant', html, id);
      return id;
    }

    function replaceBubble(id, html){
      const el=document.getElementById(id);
      if(el){ el.innerHTML = html; }
      chatBox.scrollTop=chatBox.scrollHeight;
    }

    function quickAsk(q){
      const input=document.getElementById('chatInput');
      input.value=q;
      sendChat();
    }

    // ---------- ê²½ë¡œ ìœ í‹¸ ----------
    const enc = s => String(s||'').split('/').map(encodeURIComponent).join('/');

    // HEADë¡œ ì¡´ì¬ í™•ì¸(405 ë“± ì˜ˆì™¸ì‹œ Range GETìœ¼ë¡œ ì¬ì‹œë„)
    async function exists(url){
      try{
        const h = await fetch(url, { method:'HEAD' });
        if (h.ok) return true;
        if (h.status === 405) {
          // ì¼ë¶€ ì„œë²„ê°€ HEAD ë¯¸ì§€ì›ì¼ ìˆ˜ ìˆìŒ â†’ ìµœì†Œ ë°”ì´íŠ¸ GET
          const g = await fetch(url, { method:'GET', headers:{'Range':'bytes=0-0'} });
          return g.ok;
        }
        return false;
      }catch(_){ return false; }
    }

    // íšŒì‚¬ëª…ë§Œìœ¼ë¡œ ê°€ëŠ¥í•œ URL í›„ë³´ë¥¼ ì‹œë„ â†’ ì²« ì„±ê³µ URL ë°˜í™˜
    async function resolveDocUrl(company){
      const c = enc(company);
      if (!c) return "";

      const candidates = [
        `/documents/${c}/${c}.pdf`, // ê¶Œì¥ ê·œì¹™
        `/documents/${c}.pdf`,
        `${MEDIA_BASE}documents/${c}.pdf`,
        `${MEDIA_BASE}${c}.pdf`,
        `/insurance_app/documents/${c}.pdf`,
        `/insurance_app/${c}.pdf`,
      ];

      for (const u of candidates){
        if (await exists(u)) return u;
      }
      return "";
    }

    // ê°„ë‹¨ í•˜ì´ë¼ì´íŠ¸
    function highlight(text, query){
      try{
        const terms = (query||'').split(/\s+/).filter(t=>t.length>=2);
        if(!terms.length) return text;
        let out = text;
        terms.forEach(t=>{
          const esc = t.replace(/[.*+?^${}()|[\]\\]/g, '\\\\$&');
          out = out.replace(new RegExp(esc, 'gi'), m => `<mark>${m}</mark>`);
        });
        return out;
      }catch(e){ return text; }
    }

    // ì°¸ê³  ë§í¬ HTML ë¹„ë™ê¸° ìƒì„± (doc_url/pdf_link ìš°ì„ , ì—†ìœ¼ë©´ íšŒì‚¬ëª…ìœ¼ë¡œ íƒìƒ‰)
    async function renderReferences(refs){
      const items = await Promise.all((refs||[]).map(async (ref, i)=>{
        const page = ref.page || ref.page_number || '';
        let href = ref.doc_url || ref.pdf_link || '';
        if (!href){
          const co = ref.company || ref.insurer || '';
          href = await resolveDocUrl(co);
        }
        const label = (ref.company || ref.insurer || 'ì•½ê´€') + (page?` / p.${page}`:'');
        const link = href ? `<a href="${href}${page?`#page=${page}`:''}" target="_blank" rel="noopener">ì›ë¬¸ ë³´ê¸°</a>` : '';
        return `(${i+1}) ${label} ${link}`;
      }));
      return items.join('<br/>');
    }

    async function sendChat(){
      const inp=document.getElementById('chatInput');
      const mode=(document.getElementById('answerMode').value||'normal');
      const btn=document.getElementById('chatSend');
      const q=(inp.value||'').trim();
      if(!q){ inp.focus(); return; }

      appendMsg('user', q);
      inp.value=''; btn.disabled=true;
      const pendingId = addThinkingBubble();

      try{
        const r=await fetch('/insurance-recommendation/',{
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},
          body:JSON.stringify({query:q, top_k:12, answer_mode: mode})
        });
        const data=await r.json();

        if(!data.success){
          replaceBubble(pendingId, `<div style="color:#b91c1c">ì—ëŸ¬: ${data.error||'ìš”ì²­ ì‹¤íŒ¨'}</div>`);
          return;
        }

        const answerHtml = highlight((data.answer||'').replace(/\n/g,'\n'), q);
        const refsHtml = await renderReferences(data.references || []);

        const html = `
          <div style="white-space:pre-wrap">${answerHtml}</div>
          ${refsHtml ? `<div class="meta">ê·¼ê±°<br/>${refsHtml}</div>` : ''}
        `;
        replaceBubble(pendingId, html);
      }catch(e){
        replaceBubble(pendingId, `<div style="color:#b91c1c">ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`);
        console.error(e);
      }finally{
        btn.disabled=false;
      }
    }
  </script>
</body>
</html>
