{% extends "insurance_app/layouts/base.html" %} {% load static %} {% block title %}AI 약관 검색 - 보험 챗봇{%endblock%}
{% block extra_css %}
<style>
  /* 채팅 관련 스타일 */
  .chat-container {
    max-width: 1000px;
    margin: 0 auto;
  }

  .chat-box {
    max-height: 500px;
    min-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    padding: var(--spacing-4);
    background: var(--bg-secondary);
    margin-bottom: var(--spacing-4);
  }

  .msg {
    margin: var(--spacing-4) 0;
    display: flex;
  }

  .msg.user {
    justify-content: flex-end;
  }

  .bubble {
    max-width: 80%;
    padding: var(--spacing-3) var(--spacing-4);
    border-radius: var(--radius-xl);
    line-height: 1.6;
    font-size: var(--font-size-base);
  }

  .msg.user .bubble {
    background: var(--primary-color);
    color: white;
  }

  .msg.assistant .bubble {
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    color: var(--text-primary);
  }

  .meta {
    margin-top: var(--spacing-2);
    font-size: var(--font-size-sm);
    color: var(--text-muted);
  }

  .typing {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-2);
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--primary-color);
    animation: bounce 1.2s infinite;
  }

  .dot:nth-child(2) {
    animation-delay: 0.2s;
  }
  .dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes bounce {
    0%,
    80%,
    100% {
      transform: scale(0.6);
      opacity: 0.5;
    }
    40% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .input-row {
    display: flex;
    gap: var(--spacing-3);
    align-items: stretch;
  }

  .chat-input {
    flex: 3;
  }

  .chat-input input {
    height: 48px;
    padding: var(--spacing-3);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-base);
    background: var(--bg-card);
    color: var(--text-primary);
    transition: var(--transition-fast);
    box-sizing: border-box;
  }

  .chat-input input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--primary-100);
  }

  .mode-select {
    width: 95px;
    flex-shrink: 0;
    height: 48px;
    padding: var(--spacing-3);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-base);
    background: var(--bg-card);
    color: var(--text-primary);
    cursor: pointer;
    box-sizing: border-box;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right var(--spacing-3) center;
    background-repeat: no-repeat;
    background-size: 16px 12px;
    padding-right: var(--spacing-10);
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
  }

  .mode-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--primary-100);
  }

  .input-row .btn {
    height: 48px;
    padding: 0 var(--spacing-4);
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
  }

  .example-chips {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-2);
    margin-top: var(--spacing-4);
  }

  .example-chip {
    display: inline-block;
    background: var(--bg-card);
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
    padding: var(--spacing-2) var(--spacing-3);
    border-radius: var(--radius-full);
    cursor: pointer;
    font-weight: var(--font-weight-medium);
    font-size: var(--font-size-sm);
    transition: var(--transition-fast);
  }

  .example-chip:hover {
    background: var(--primary-color);
    color: white;
  }

  mark {
    background: #fff2ac;
    padding: 0 0.2em;
    border-radius: 0.2em;
  }

  /* 반응형 디자인 */
  @media (max-width: 768px) {
    .input-row {
      flex-direction: column;
      gap: var(--spacing-2);
    }

    .mode-select {
      min-width: auto;
      width: 100%;
    }

    .chat-input input,
    .mode-select,
    .input-row .btn {
      height: 44px;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="chat-container">
  <!-- 페이지 헤더 -->
  <div class="card" style="margin-bottom: var(--spacing-6)">
    <div class="card-body" style="text-align: center">
      <div
        style="
          width: 80px;
          height: 80px;
          background: var(--primary-100);
          border-radius: var(--radius-2xl);
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0 auto var(--spacing-4);
        "
      >
        <span style="font-size: 40px">🤖</span>
      </div>
      <h1
        style="
          font-size: var(--font-size-4xl);
          font-weight: var(--font-weight-extrabold);
          color: var(--text-primary);
          margin-bottom: var(--spacing-3);
        "
      >
        AI 약관 검색
      </h1>
      <p style="font-size: var(--font-size-lg); color: var(--text-secondary); margin-bottom: var(--spacing-4)">
        자연어로 질문하면, 관련 약관을 찾아 근거와 함께 답해드려요
      </p>

      {% if user.is_authenticated %}
      <div class="alert alert-info">
        <strong>👤 {{ user.username }}</strong>
        님, 궁금한 약관을 물어보세요.
      </div>
      {% endif %}
    </div>
  </div>

  <!-- 채팅 영역 -->
  <div class="card" style="margin-bottom: var(--spacing-6)">
    <div class="card-header">
      <h3 style="margin: 0; font-weight: var(--font-weight-bold)">💬 대화</h3>
    </div>
    <div class="card-body">
      <div id="chatBox" class="chat-box"></div>

      <div class="input-row">
        <div class="chat-input">
          <input
            id="chatInput"
            class="form-input"
            type="text"
            placeholder="예) 음주운전 사고 시 보상여부는? / 무사고 할인 기준은?"
            onkeypress="if(event.key==='Enter'){sendChat()}"
          />
        </div>

        <select id="answerMode" class="form-input mode-select">
          <option value="brief">간단</option>
          <option value="normal" selected>자세히</option>
          <option value="clauses">조항만</option>
        </select>

        <button id="chatSend" class="btn btn-primary" onclick="sendChat()">질문하기</button>
      </div>
    </div>
  </div>

  <!-- 예시 질문 -->
  <div class="card">
    <div class="card-header">
      <h3 style="margin: 0; font-weight: var(--font-weight-bold)">💡 예시 질문</h3>
    </div>
    <div class="card-body">
      <div class="example-chips">
        <span class="example-chip" onclick="quickAsk('음주운전으로 사고가 났을 때 보상되나요?')">
          음주운전 보상 여부
        </span>
        <span class="example-chip" onclick="quickAsk('무사고 할인은 어떻게 적용되나요?')">무사고 할인 기준</span>
        <span class="example-chip" onclick="quickAsk('가족 특약 혜택은 어떻게 되나요?')">가족 특약</span>
        <span class="example-chip" onclick="quickAsk('차량 도난 시 보상 기준은?')">도난 보상</span>
        <span class="example-chip" onclick="quickAsk('자차보험과 종합보험의 차이점은?')">보험 종류 차이</span>
        <span class="example-chip" onclick="quickAsk('사고 시 보험금 청구 절차는?')">청구 절차</span>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // MEDIA_URL 컨텍스트가 없는 환경 대비
  const MEDIA_BASE = "{{ MEDIA_URL|default:'/media/' }}";

  function getCookie(name) {
    let v = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const c = cookies[i].trim();
        if (c.substring(0, name.length + 1) === name + '=') {
          v = decodeURIComponent(c.substring(name.length + 1));
          break;
        }
      }
    }
    return v;
  }

  const chatBox = document.getElementById('chatBox');

  function appendMsg(role, html, id = null) {
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + role;
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = html;
    if (id) bubble.id = id;
    wrap.appendChild(bubble);
    chatBox.appendChild(wrap);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function addThinkingBubble() {
    const id = 'pending-' + Date.now();
    const html = `<div class="typing"><span>관련 약관을 찾는 중이에요...</span>
        <span class="dot"></span><span class="dot"></span><span class="dot"></span></div>`;
    appendMsg('assistant', html, id);
    return id;
  }

  function replaceBubble(id, html) {
    const el = document.getElementById(id);
    if (el) {
      el.innerHTML = html;
    }
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function quickAsk(q) {
    const input = document.getElementById('chatInput');
    input.value = q;
    sendChat();
  }

  // ---------- 경로 유틸 ----------
  const enc = (s) =>
    String(s || '')
      .split('/')
      .map(encodeURIComponent)
      .join('/');

  // HEAD로 존재 확인(405 등 예외시 Range GET으로 재시도)
  async function exists(url) {
    try {
      const h = await fetch(url, { method: 'HEAD' });
      if (h.ok) return true;
      if (h.status === 405) {
        // 일부 서버가 HEAD 미지원일 수 있음 → 최소 바이트 GET
        const g = await fetch(url, { method: 'GET', headers: { Range: 'bytes=0-0' } });
        return g.ok;
      }
      return false;
    } catch (_) {
      return false;
    }
  }

  // 회사명만으로 가능한 URL 후보를 시도 → 첫 성공 URL 반환
  async function resolveDocUrl(company) {
    const c = enc(company);
    if (!c) return '';

    const candidates = [
      `/documents/${c}/${c}.pdf`, // 권장 규칙
      `/documents/${c}.pdf`,
      `${MEDIA_BASE}documents/${c}.pdf`,
      `${MEDIA_BASE}${c}.pdf`,
      `/insurance_app/documents/${c}.pdf`,
      `/insurance_app/${c}.pdf`,
    ];

    for (const u of candidates) {
      if (await exists(u)) return u;
    }
    return '';
  }

  // 간단 하이라이트
  function highlight(text, query) {
    try {
      const terms = (query || '').split(/\s+/).filter((t) => t.length >= 2);
      if (!terms.length) return text;
      let out = text;
      terms.forEach((t) => {
        const esc = t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        out = out.replace(new RegExp(esc, 'gi'), (m) => `<mark>${m}</mark>`);
      });
      return out;
    } catch (e) {
      return text;
    }
  }

  // 참고 링크 HTML 비동기 생성 (doc_url/pdf_link 우선, 없으면 회사명으로 탐색)
  async function renderReferences(refs) {
    const items = await Promise.all(
      (refs || []).map(async (ref, i) => {
        const page = ref.page || ref.page_number || '';
        let href = ref.doc_url || ref.pdf_link || '';
        if (!href) {
          const co = ref.company || ref.insurer || '';
          href = await resolveDocUrl(co);
        }
        const label = (ref.company || ref.insurer || '약관') + (page ? ` / p.${page}` : '');
        const link = href
          ? `<a href="${href}${page ? `#page=${page}` : ''}" target="_blank" rel="noopener">원문 보기</a>`
          : '';
        return `(${i + 1}) ${label} ${link}`;
      })
    );
    return items.join('<br/>');
  }

  async function sendChat() {
    const inp = document.getElementById('chatInput');
    const mode = document.getElementById('answerMode').value || 'normal';
    const btn = document.getElementById('chatSend');
    const q = (inp.value || '').trim();
    if (!q) {
      inp.focus();
      return;
    }

    appendMsg('user', q);
    inp.value = '';
    btn.disabled = true;
    const pendingId = addThinkingBubble();

    try {
      const r = await fetch('/insurance-recommendation/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ query: q, top_k: 12, answer_mode: mode }),
      });
      const data = await r.json();

      if (!data.success) {
        replaceBubble(pendingId, `<div style="color:#b91c1c">에러: ${data.error || '요청 실패'}</div>`);
        return;
      }

      const answerHtml = highlight((data.answer || '').replace(/\n/g, '\n'), q);
      const refsHtml = await renderReferences(data.references || []);

      const html = `
          <div style="white-space:pre-wrap">${answerHtml}</div>
          ${refsHtml ? `<div class="meta">근거<br/>${refsHtml}</div>` : ''}
        `;
      replaceBubble(pendingId, html);
    } catch (e) {
      replaceBubble(pendingId, `<div style="color:#b91c1c">요청 중 오류가 발생했습니다.</div>`);
      console.error(e);
    } finally {
      btn.disabled = false;
    }
  }
</script>
{% endblock %}
