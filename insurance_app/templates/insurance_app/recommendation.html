{% extends "insurance_app/layouts/base.html" %} {% load static %} {% block title %}AI ì•½ê´€ ê²€ìƒ‰ - ë³´í—˜ ì±—ë´‡{%endblock%}
{% block extra_css %}
<style>
  /* ì±„íŒ… ê´€ë ¨ ìŠ¤íƒ€ì¼ */
  .chat-container {
    max-width: 1000px;
    margin: 0 auto;
  }

  .chat-box {
    max-height: 500px;
    min-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    padding: var(--spacing-4);
    background: var(--bg-secondary);
    margin-bottom: var(--spacing-4);
  }

  .msg {
    margin: var(--spacing-4) 0;
    display: flex;
  }

  .msg.user {
    justify-content: flex-end;
  }

  .bubble {
    max-width: 80%;
    padding: var(--spacing-3) var(--spacing-4);
    border-radius: var(--radius-xl);
    line-height: 1.6;
    font-size: var(--font-size-base);
  }

  .msg.user .bubble {
    background: var(--primary-color);
    color: white;
  }

  .msg.assistant .bubble {
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    color: var(--text-primary);
  }

  .meta {
    margin-top: var(--spacing-2);
    font-size: var(--font-size-sm);
    color: var(--text-muted);
  }

  .typing {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-2);
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--primary-color);
    animation: bounce 1.2s infinite;
  }

  .dot:nth-child(2) {
    animation-delay: 0.2s;
  }
  .dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes bounce {
    0%,
    80%,
    100% {
      transform: scale(0.6);
      opacity: 0.5;
    }
    40% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .input-row {
    display: flex;
    gap: var(--spacing-3);
    align-items: stretch;
  }

  .chat-input {
    flex: 3;
  }

  .chat-input input {
    height: 48px;
    padding: var(--spacing-3);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-base);
    background: var(--bg-card);
    color: var(--text-primary);
    transition: var(--transition-fast);
    box-sizing: border-box;
  }

  .chat-input input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--primary-100);
  }

  .mode-select {
    width: 95px;
    flex-shrink: 0;
    height: 48px;
    padding: var(--spacing-3);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-base);
    background: var(--bg-card);
    color: var(--text-primary);
    cursor: pointer;
    box-sizing: border-box;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right var(--spacing-3) center;
    background-repeat: no-repeat;
    background-size: 16px 12px;
    padding-right: var(--spacing-10);
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
  }

  .mode-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--primary-100);
  }

  .input-row .btn {
    height: 48px;
    padding: 0 var(--spacing-4);
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
  }

  .example-chips {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-2);
    margin-top: var(--spacing-4);
  }

  .example-chip {
    display: inline-block;
    background: var(--bg-card);
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
    padding: var(--spacing-2) var(--spacing-3);
    border-radius: var(--radius-full);
    cursor: pointer;
    font-weight: var(--font-weight-medium);
    font-size: var(--font-size-sm);
    transition: var(--transition-fast);
  }

  .example-chip:hover {
    background: var(--primary-color);
    color: white;
  }

  mark {
    background: #fff2ac;
    padding: 0 0.2em;
    border-radius: 0.2em;
  }

  /* ë°˜ì‘í˜• ë””ìì¸ */
  @media (max-width: 768px) {
    .input-row {
      flex-direction: column;
      gap: var(--spacing-2);
    }

    .mode-select {
      min-width: auto;
      width: 100%;
    }

    .chat-input input,
    .mode-select,
    .input-row .btn {
      height: 44px;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="chat-container">
  <!-- í˜ì´ì§€ í—¤ë” -->
  <div class="card" style="margin-bottom: var(--spacing-6)">
    <div class="card-body" style="text-align: center">
      <div
        style="
          width: 80px;
          height: 80px;
          background: var(--primary-100);
          border-radius: var(--radius-2xl);
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0 auto var(--spacing-4);
        "
      >
        <span style="font-size: 40px">ğŸ¤–</span>
      </div>
      <h1
        style="
          font-size: var(--font-size-4xl);
          font-weight: var(--font-weight-extrabold);
          color: var(--text-primary);
          margin-bottom: var(--spacing-3);
        "
      >
        AI ì•½ê´€ ê²€ìƒ‰
      </h1>
      <p style="font-size: var(--font-size-lg); color: var(--text-secondary); margin-bottom: var(--spacing-4)">
        ìì—°ì–´ë¡œ ì§ˆë¬¸í•˜ë©´, ê´€ë ¨ ì•½ê´€ì„ ì°¾ì•„ ê·¼ê±°ì™€ í•¨ê»˜ ë‹µí•´ë“œë ¤ìš”
      </p>

      {% if user.is_authenticated %}
      <div class="alert alert-info">
        <strong>ğŸ‘¤ {{ user.username }}</strong>
        ë‹˜, ê¶ê¸ˆí•œ ì•½ê´€ì„ ë¬¼ì–´ë³´ì„¸ìš”.
      </div>
      {% endif %}
    </div>
  </div>

  <!-- ì±„íŒ… ì˜ì—­ -->
  <div class="card" style="margin-bottom: var(--spacing-6)">
    <div class="card-header">
      <h3 style="margin: 0; font-weight: var(--font-weight-bold)">ğŸ’¬ ëŒ€í™”</h3>
    </div>
    <div class="card-body">
      <div id="chatBox" class="chat-box"></div>

      <div class="input-row">
        <div class="chat-input">
          <input
            id="chatInput"
            class="form-input"
            type="text"
            placeholder="ì˜ˆ) ìŒì£¼ìš´ì „ ì‚¬ê³  ì‹œ ë³´ìƒì—¬ë¶€ëŠ”? / ë¬´ì‚¬ê³  í• ì¸ ê¸°ì¤€ì€?"
            onkeypress="if(event.key==='Enter'){sendChat()}"
          />
        </div>

        <select id="answerMode" class="form-input mode-select">
          <option value="brief">ê°„ë‹¨</option>
          <option value="normal" selected>ìì„¸íˆ</option>
          <option value="clauses">ì¡°í•­ë§Œ</option>
        </select>

        <button id="chatSend" class="btn btn-primary" onclick="sendChat()">ì§ˆë¬¸í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì˜ˆì‹œ ì§ˆë¬¸ -->
  <div class="card">
    <div class="card-header">
      <h3 style="margin: 0; font-weight: var(--font-weight-bold)">ğŸ’¡ ì˜ˆì‹œ ì§ˆë¬¸</h3>
    </div>
    <div class="card-body">
      <div class="example-chips">
        <span class="example-chip" onclick="quickAsk('ìŒì£¼ìš´ì „ìœ¼ë¡œ ì‚¬ê³ ê°€ ë‚¬ì„ ë•Œ ë³´ìƒë˜ë‚˜ìš”?')">
          ìŒì£¼ìš´ì „ ë³´ìƒ ì—¬ë¶€
        </span>
        <span class="example-chip" onclick="quickAsk('ë¬´ì‚¬ê³  í• ì¸ì€ ì–´ë–»ê²Œ ì ìš©ë˜ë‚˜ìš”?')">ë¬´ì‚¬ê³  í• ì¸ ê¸°ì¤€</span>
        <span class="example-chip" onclick="quickAsk('ê°€ì¡± íŠ¹ì•½ í˜œíƒì€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?')">ê°€ì¡± íŠ¹ì•½</span>
        <span class="example-chip" onclick="quickAsk('ì°¨ëŸ‰ ë„ë‚œ ì‹œ ë³´ìƒ ê¸°ì¤€ì€?')">ë„ë‚œ ë³´ìƒ</span>
        <span class="example-chip" onclick="quickAsk('ìì°¨ë³´í—˜ê³¼ ì¢…í•©ë³´í—˜ì˜ ì°¨ì´ì ì€?')">ë³´í—˜ ì¢…ë¥˜ ì°¨ì´</span>
        <span class="example-chip" onclick="quickAsk('ì‚¬ê³  ì‹œ ë³´í—˜ê¸ˆ ì²­êµ¬ ì ˆì°¨ëŠ”?')">ì²­êµ¬ ì ˆì°¨</span>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // MEDIA_URL ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ëŠ” í™˜ê²½ ëŒ€ë¹„
  const MEDIA_BASE = "{{ MEDIA_URL|default:'/media/' }}";

  function getCookie(name) {
    let v = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const c = cookies[i].trim();
        if (c.substring(0, name.length + 1) === name + '=') {
          v = decodeURIComponent(c.substring(name.length + 1));
          break;
        }
      }
    }
    return v;
  }

  const chatBox = document.getElementById('chatBox');

  function appendMsg(role, html, id = null) {
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + role;
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = html;
    if (id) bubble.id = id;
    wrap.appendChild(bubble);
    chatBox.appendChild(wrap);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function addThinkingBubble() {
    const id = 'pending-' + Date.now();
    const html = `<div class="typing"><span>ê´€ë ¨ ì•½ê´€ì„ ì°¾ëŠ” ì¤‘ì´ì—ìš”...</span>
        <span class="dot"></span><span class="dot"></span><span class="dot"></span></div>`;
    appendMsg('assistant', html, id);
    return id;
  }

  function replaceBubble(id, html) {
    const el = document.getElementById(id);
    if (el) {
      el.innerHTML = html;
    }
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function quickAsk(q) {
    const input = document.getElementById('chatInput');
    input.value = q;
    sendChat();
  }

  // ---------- ê²½ë¡œ ìœ í‹¸ ----------
  const enc = (s) =>
    String(s || '')
      .split('/')
      .map(encodeURIComponent)
      .join('/');

  // HEADë¡œ ì¡´ì¬ í™•ì¸(405 ë“± ì˜ˆì™¸ì‹œ Range GETìœ¼ë¡œ ì¬ì‹œë„)
  async function exists(url) {
    try {
      const h = await fetch(url, { method: 'HEAD' });
      if (h.ok) return true;
      if (h.status === 405) {
        // ì¼ë¶€ ì„œë²„ê°€ HEAD ë¯¸ì§€ì›ì¼ ìˆ˜ ìˆìŒ â†’ ìµœì†Œ ë°”ì´íŠ¸ GET
        const g = await fetch(url, { method: 'GET', headers: { Range: 'bytes=0-0' } });
        return g.ok;
      }
      return false;
    } catch (_) {
      return false;
    }
  }

  // íšŒì‚¬ëª…ë§Œìœ¼ë¡œ ê°€ëŠ¥í•œ URL í›„ë³´ë¥¼ ì‹œë„ â†’ ì²« ì„±ê³µ URL ë°˜í™˜
  async function resolveDocUrl(company) {
    const c = enc(company);
    if (!c) return '';

    const candidates = [
      `/documents/${c}/${c}.pdf`, // ê¶Œì¥ ê·œì¹™
      `/documents/${c}.pdf`,
      `${MEDIA_BASE}documents/${c}.pdf`,
      `${MEDIA_BASE}${c}.pdf`,
      `/insurance_app/documents/${c}.pdf`,
      `/insurance_app/${c}.pdf`,
    ];

    for (const u of candidates) {
      if (await exists(u)) return u;
    }
    return '';
  }

  // ê°„ë‹¨ í•˜ì´ë¼ì´íŠ¸
  function highlight(text, query) {
    try {
      const terms = (query || '').split(/\s+/).filter((t) => t.length >= 2);
      if (!terms.length) return text;
      let out = text;
      terms.forEach((t) => {
        const esc = t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        out = out.replace(new RegExp(esc, 'gi'), (m) => `<mark>${m}</mark>`);
      });
      return out;
    } catch (e) {
      return text;
    }
  }

  // ì°¸ê³  ë§í¬ HTML ë¹„ë™ê¸° ìƒì„± (doc_url/pdf_link ìš°ì„ , ì—†ìœ¼ë©´ íšŒì‚¬ëª…ìœ¼ë¡œ íƒìƒ‰)
  async function renderReferences(refs) {
    const items = await Promise.all(
      (refs || []).map(async (ref, i) => {
        const page = ref.page || ref.page_number || '';
        let href = ref.doc_url || ref.pdf_link || '';
        if (!href) {
          const co = ref.company || ref.insurer || '';
          href = await resolveDocUrl(co);
        }
        const label = (ref.company || ref.insurer || 'ì•½ê´€') + (page ? ` / p.${page}` : '');
        const link = href
          ? `<a href="${href}${page ? `#page=${page}` : ''}" target="_blank" rel="noopener">ì›ë¬¸ ë³´ê¸°</a>`
          : '';
        return `(${i + 1}) ${label} ${link}`;
      })
    );
    return items.join('<br/>');
  }

  async function sendChat() {
    const inp = document.getElementById('chatInput');
    const mode = document.getElementById('answerMode').value || 'normal';
    const btn = document.getElementById('chatSend');
    const q = (inp.value || '').trim();
    if (!q) {
      inp.focus();
      return;
    }

    appendMsg('user', q);
    inp.value = '';
    btn.disabled = true;
    const pendingId = addThinkingBubble();

    try {
      const r = await fetch('/insurance-recommendation/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ query: q, top_k: 12, answer_mode: mode }),
      });
      const data = await r.json();

      if (!data.success) {
        replaceBubble(pendingId, `<div style="color:#b91c1c">ì—ëŸ¬: ${data.error || 'ìš”ì²­ ì‹¤íŒ¨'}</div>`);
        return;
      }

      const answerHtml = highlight((data.answer || '').replace(/\n/g, '\n'), q);
      const refsHtml = await renderReferences(data.references || []);

      const html = `
          <div style="white-space:pre-wrap">${answerHtml}</div>
          ${refsHtml ? `<div class="meta">ê·¼ê±°<br/>${refsHtml}</div>` : ''}
        `;
      replaceBubble(pendingId, html);
    } catch (e) {
      replaceBubble(pendingId, `<div style="color:#b91c1c">ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`);
      console.error(e);
    } finally {
      btn.disabled = false;
    }
  }
</script>
{% endblock %}
