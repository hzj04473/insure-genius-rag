{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>êµí†µì‚¬ê³  ì‹ ì†ì²˜ë¦¬ í‘œì¤€ í˜‘ì˜ì„œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===== ê³µí†µ ===== */
    :root { --line:1px; --pad:8px; --font:14px; }
    *{ box-sizing:border-box; }
    body{ font-family:'Malgun Gothic','ë§‘ì€ ê³ ë”•',NanumGothic,Arial,sans-serif; margin:0; padding:16px; font-size:var(--font); }
    h2{ margin:0 0 8px 0; text-align:center; }

    input, textarea, select{ width:100%; padding:5px; font-size:var(--font); }
    .box{ border:var(--line) solid #000; background:#fff; margin-bottom:8px; }
    .grid{ display:grid; }
    .row{ display:flex; }
    .cell{ padding:var(--pad); border-bottom:var(--line) solid #000; border-right:var(--line) solid #000; }
    .cell:last-child{ border-right:0; }
    .no-bb{ border-bottom:0 !important; }
    .no-br{ border-right:0 !important; }
    .hdr{ background:#f7f7f7; font-weight:700; }
    .tight{ padding:6px; }
    .label{ font-weight:700; white-space:nowrap; }

    /* ìƒë‹¨ ë©”íƒ€ */
    table.meta{ width:100%; border-collapse:collapse; margin-bottom:8px; }
    table.meta th, table.meta td{ border:var(--line) solid #000; padding:6px 8px; text-align:left; vertical-align:middle; }
    .weather-row{ display:flex; gap:12px; align-items:center; white-space:nowrap; flex-wrap:wrap; }
    .weather-row label{ display:inline-flex; align-items:center; gap:6px; }
    .weather-row input[type="checkbox"]{ transform:scale(0.9); margin:0; }

    /* ì¢Œì¸¡ ì„¸ë¡œ ë¼ë²¨ */
    .title-v{ writing-mode:vertical-rl; text-align:center; font-weight:700; padding:8px 4px; border-right:var(--line) solid #000; }

    /* 3ë‹¨ ë¹„ìœ¨ */
    .cols-3{ grid-template-columns:37.5% 37.5% 25%; }
    .two-col{ grid-template-columns:22% 78%; }

    /* íŒŒì†ë¶€ìœ„ ë„ë©´ + ë§ˆí‚¹ */
    .damage-wrap{ padding:6px 8px; }
    .damage-head{ font-weight:700; margin-bottom:6px; }
    .damage-img-box{
      border:var(--line) solid #000; height:200px; display:flex;
      align-items:center; justify-content:center; background:#fff; position:relative; overflow:hidden;
    }
    .damage-img-box img{ max-width:95%; max-height:95%; object-fit:contain; }
    .mark{ position:absolute; width:18px; height:18px; border:2px solid #d00; border-radius:50%;
          transform:translate(-50%,-50%); display:flex; align-items:center; justify-content:center;
          font-size:12px; font-weight:900; color:#d00; background:rgba(255,255,255,0.85); }

    .desc-area{ height:70px; border:var(--line) solid #000; }

    /* ì‚¬ê³ ë‚´ìš© í‘œ */
    table.acc { width:100%; border-collapse:collapse; }
    table.acc th, table.acc td { border:var(--line) solid #000; padding:6px 8px; vertical-align:top; }

    /* â€˜ì‚¬ê³ ë‚´ìš©/ì•½ë„â€™ 2ì—´ */
    .acc-wrap{ display:grid; grid-template-columns:65% 35%; }
    .acc-left{ border-right:var(--line) solid #000; }
    .acc-right{ position:relative; background:#fff; min-height:180px; }
    .acc-right .tag{ position:absolute; top:6px; left:8px; font-weight:700; }

    /* ë³´í—˜ì²­êµ¬ ì„œëª… */
    .sign-table{ width:100%; border-collapse:collapse; }
    .sign-table td{ border:var(--line) solid #000; padding:12px; text-align:center; }

    /* ì„¹ì…˜ íƒ€ì´í‹€ */
    .section-title{ font-weight:800; margin:6px 0; }

    /* ë²„íŠ¼ ì¤„ */
    .btns{ display:flex; gap:10px; margin-top:12px; justify-content:flex-end; }

    /* ---- ë°˜ì‘í˜• (ëª¨ë°”ì¼) ---- */
    @media (max-width: 900px){
      :root { --font: 13px; }
      body { padding: 10px; }
      .cols-3{ grid-template-columns: 1fr; }           /* 3ì—´ â†’ 1ì—´ */
      .acc-wrap{ grid-template-columns: 1fr; }         /* 2ì—´ â†’ 1ì—´ */
      .title-v{
        writing-mode: initial;                          /* ì„¸ë¡œ â†’ ê°€ë¡œ */
        border-right: 0; border-bottom: var(--line) solid #000;
        padding: 6px 8px; text-align: left;
      }
      .damage-img-box{ height: 180px; }
      table.meta th, table.meta td{ padding: 6px; }
      .two-col{ grid-template-columns: 28% 72%; }
      .btns{ justify-content: stretch; }
      .btns button{ width: 50%; }
    }
    /* ===== ìƒˆë¡œìš´ ìŠ¤íƒ€ì¼ (Phase 3) ===== */
    /* íŒŒì†ë¶€ìœ„ ì»¨íŠ¸ë¡¤ ì˜ì—­ */
    .damage-controls {
        margin: 8px 0;
        padding: 8px;
        background: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
    }

    .instruction {
        margin: 0 0 8px 0;
        font-size: 13px;
        color: #666;
        font-weight: normal;
    }

    .control-buttons {
        display: flex;
        gap: 8px;
    }

    .btn-reset, .btn-undo {
        padding: 6px 12px;
        font-size: 12px;
        border: 1px solid #ccc;
        background: white;
        cursor: pointer;
        border-radius: 3px;
        color: #333;
    }

    .btn-reset:hover { 
        background: #f0f0f0; 
        border-color: #999;
    }

    .btn-undo:hover { 
        background: #f0f0f0; 
        border-color: #999;
    }

    /* ìƒˆë¡œìš´ í´ë¦­í˜• íŒŒì† ë§ˆí¬ */
    .damage-mark {
        position: absolute;
        width: 20px;
        height: 20px;
        border: 2px solid #d00;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 900;
        color: #d00;
        background: rgba(255,255,255,0.9);
        cursor: pointer;
        z-index: 10;
    }

    /* ì´ë¯¸ì§€ ë°•ìŠ¤ í´ë¦­ ê°€ëŠ¥ í‘œì‹œ */
    .damage-img-box {
        cursor: crosshair;
    }

    .damage-img-box:hover {
        background: #f8f8f8;
    }

    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 900px) {
        .control-buttons {
            flex-direction: column;
        }
        
        .btn-reset, .btn-undo {
            width: 100%;
            padding: 8px;
        }
        
        .damage-mark {
            width: 24px;
            height: 24px;
            font-size: 16px;
        }
    }
    /* ===== í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì‹œìŠ¤í…œ ===== */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        pointer-events: none;
    }

    .toast {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        padding: 12px 16px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        min-width: 280px;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        pointer-events: all;
    }

    .toast.show {
        transform: translateX(0);
    }

    .toast.error {
        border-left: 4px solid #e74c3c;
        background: #fdf2f2;
    }

    .toast.success {
        border-left: 4px solid #27ae60;
        background: #f2fdf2;
    }

    .toast.info {
        border-left: 4px solid #3498db;
        background: #f2f8fd;
    }

    .toast-icon {
        font-size: 18px;
        margin-right: 10px;
    }

    .toast.error .toast-icon {
        color: #e74c3c;
    }

    .toast.success .toast-icon {
        color: #27ae60;
    }

    .toast.info .toast-icon {
        color: #3498db;
    }

    .toast-message {
        flex: 1;
        font-size: 14px;
        color: #333;
    }

    .toast-close {
        background: none;
        border: none;
        font-size: 18px;
        color: #999;
        cursor: pointer;
        padding: 0 0 0 8px;
    }

    /* ì´ë¯¸ì§€ ì˜ì—­ ê°€ì´ë“œ */
    .damage-img-box img {
        border: 2px dashed #ddd;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .damage-img-box:hover img {
        border-color: #3498db;
        box-shadow: 0 0 8px rgba(52, 152, 219, 0.3);
    }

    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 900px) {
        .toast-container {
            top: 10px;
            right: 10px;
            left: 10px;
        }
        
        .toast {
            min-width: auto;
            margin: 0 0 8px 0;
        }
    }

    .mark-counter {
    font-weight: bold;
    color: #3498db;
}

  </style>
</head>
<body>
  <h2>êµí†µì‚¬ê³  ì‹ ì†ì²˜ë¦¬ í‘œì¤€ í˜‘ì˜ì„œ</h2>

  <form method="post" action="{% url 'accident_project:agreement_form' %}"></form>
    {% csrf_token %}

    <!-- ìƒë‹¨ ë©”íƒ€ ì •ë³´ -->
    <table class="meta">
      <tr>
        <th style="width:12%">ì‚¬ê³ ì¼ì‹œ</th>
        <td style="width:33%"><input type="datetime-local" name="accident_date" /></td>
        <th style="width:10%">ì‚¬ê³ ì¥ì†Œ</th>
        <td style="width:30%"><input type="text" name="location" /></td>
        <th style="width:7%">ë‚ ì”¨</th>
        <td>
          <div class="weather-row">
            <label><input type="checkbox" name="weather" value="ë§‘ìŒ" />ë§‘ìŒ</label>
            <label><input type="checkbox" name="weather" value="íë¦¼" />íë¦¼</label>
            <label><input type="checkbox" name="weather" value="ë¹„" />ë¹„</label>
            <label><input type="checkbox" name="weather" value="ëˆˆ" />ëˆˆ</label>
            <label><input type="checkbox" name="weather" value="ì•ˆê°œ" />ì•ˆê°œ</label>
          </div>
        </td>
      </tr>
    </table>

    <!-- ì‚¬ê³  ê´€ê³„ì ì •ë³´ ë° í”¼í•´ìƒíƒœ -->
    <div class="box">
      <div class="row" style="border-bottom:var(--line) solid #000; align-items:stretch;">
        <div class="title-v">ì‚¬ê³  ê´€ê³„ì ì •ë³´ ë° í”¼í•´ìƒíƒœ</div>
        <div style="flex:1;">
          <div class="grid cols-3">

            <!-- A ì°¨ëŸ‰ -->
            <div style="border-right:var(--line) solid #000;">
              <div class="section-title">A ì°¨ëŸ‰</div>
              <div class="grid two-col">
                <div class="cell hdr">ì°¨ëŸ‰ë²ˆí˜¸</div>
                <div class="cell"><input name="a_plate" placeholder="ì˜ˆ: 12ê°€3456" required /></div>
                <div class="cell hdr">ë³´í—˜ì‚¬</div>
                <div class="cell">
                  <select name="a_insurer" required>
                    <option value="">ë³´í—˜ì‚¬ ì„ íƒ</option>
                    <option value="ë©”ë¦¬ì¸ í™”ì¬">ë©”ë¦¬ì¸ í™”ì¬</option>
                    <option value="í•œí™”ì†í•´ë³´í—˜">í•œí™”ì†í•´ë³´í—˜</option>
                    <option value="ë¡¯ë°ì†í•´ë³´í—˜">ë¡¯ë°ì†í•´ë³´í—˜</option>
                    <option value="MGì†í•´ë³´í—˜">MGì†í•´ë³´í—˜</option>
                    <option value="í¥êµ­í™”ì¬">í¥êµ­í™”ì¬</option>
                    <option value="ì‚¼ì„±í™”ì¬">ì‚¼ì„±í™”ì¬</option>
                    <option value="AXAì†í•´ë³´í—˜">AXAì†í•´ë³´í—˜</option>
                    <option value="í˜„ëŒ€í•´ìƒ">í˜„ëŒ€í•´ìƒ</option>
                    <option value="DBì†í•´ë³´í—˜">DBì†í•´ë³´í—˜</option>
                    <option value="AXAì†í•´ë³´í—˜">AXAì†í•´ë³´í—˜</option>
                    <option value="í•˜ë‚˜ì†í•´ë³´í—˜">í•˜ë‚˜ì†í•´ë³´í—˜</option>
                    <option value="ìºë¡¯ì†í•´ë³´í—˜">ìºë¡¯ì†í•´ë³´í—˜</option>
                  </select>
                </div>
              </div>
              <div class="grid two-col">
                <div class="cell hdr">ìš´ì „ì<br/>ì •ë³´</div><div class="cell tight"></div>
                <div class="cell hdr">ì„± ëª…</div>
                <div class="cell"><input name="a_name" placeholder="ì˜ˆ: í™ê¸¸ë™" pattern="[ê°€-í£]{2,5}" title="í•œê¸€ 2-5ê¸€ìë¡œ ì…ë ¥í•˜ì„¸ìš”" required /></div>
                <div class="cell hdr">ì£¼ë¯¼ë²ˆí˜¸</div>
                <div class="cell"><input name="a_id" placeholder="ì˜ˆ: 800101-1******" pattern="[0-9]{6}-[0-9]{7}" title="ì£¼ë¯¼ë²ˆí˜¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”" required /></div>
                <div class="cell hdr">ì „í™”ë²ˆí˜¸<br/><small>(íœ´ëŒ€í°ë²ˆí˜¸)</small></div>
                <div class="cell"><input name="a_phone" placeholder="ì˜ˆ: 010-1234-5678" pattern="010-[0-9]{4}-[0-9]{4}" title="010-0000-0000 í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”" required /></div>
                <div class="cell hdr">ì£¼ ì†Œ</div>
                <div class="cell"><input name="a_address" placeholder="ì˜ˆ: ì„œìš¸ ê°•ë‚¨êµ¬..." required /></div>
              </div>
              <div class="grid two-col">
                <div class="cell hdr">íƒ‘ìŠ¹ì¸ì›<br/><span style="font-weight:400;">(ìš´ì „ìì œì™¸)</span></div>
                <div class="cell">
                  <div style="display:flex; gap:8px; align-items:center;">
                    ë‚¨ <input type="number" min="0" value="0" id="a_male" style="width:70px" required />
                    ì—¬ <input type="number" min="0" value="0" id="a_female" style="width:70px" required />
                    <span style="flex:1"></span><b>í•©ê³„</b> <span id="a_total">0</span>ëª…
                  </div>
                </div>
              </div>

              <div class="damage-wrap">
                <div class="damage-head">[íŒŒì†ë¶€ìœ„] : í•´ë‹¹ ë¶€ìœ„ì— V í‘œì‹œ</div>

                <!-- ì²´í¬ë°•ìŠ¤: ì „ë©´/í›„ë©´/íƒ€ì´ì–´/íŠ¸ë í¬ -->
                {% comment %} <div class="weather-row" style="margin-bottom:6px;">
                  <label><input type="checkbox" name="a_mark" value="ì „ë©´"  data-target="a" /> ì „ë©´</label>
                  <label><input type="checkbox" name="a_mark" value="í›„ë©´"  data-target="a" /> í›„ë©´</label>
                  <label><input type="checkbox" name="a_mark" value="íƒ€ì´ì–´" data-target="a" /> íƒ€ì´ì–´</label>
                  <label><input type="checkbox" name="a_mark" value="íŠ¸ë í¬" data-target="a" /> íŠ¸ë í¬</label>
                </div> {% endcomment %}
                <!-- ìƒˆë¡œìš´ ì»¨íŠ¸ë¡¤ ì˜ì—­ -->
                <div class="damage-controls">
                  <p class="instruction">
                    ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ì—¬ íŒŒì†ë¶€ìœ„ë¥¼ í‘œì‹œí•˜ì„¸ìš” 
                    <span class="mark-counter" id="a_counter">(0/5)</span>
                  </p>
                  <div class="control-buttons">
                    <button type="button" class="btn-reset" onclick="resetMarks('a')">ì²´í¬ ì´ˆê¸°í™”</button>
                    <button type="button" class="btn-undo" onclick="undoLastMark('a')">ì´ì „ ì²´í¬ ì‚­ì œ</button>
                  </div>
                </div>


                <div class="damage-img-box" id="a_imgbox">
                  <img src="{% static 'images/damage_outline.png' %}" alt="Aì°¨ëŸ‰ íŒŒì†ë¶€ìœ„ ë„ë©´" />
                  <!-- ë§ˆí‚¹ ì˜¤ë²„ë ˆì´ (ì²´í¬ì‹œ í‘œì‹œ) -->
                  <div class="mark" id="a_mark_ì „ë©´"  style="left:35%; top:25%; display:none;">V</div>
                  <div class="mark" id="a_mark_í›„ë©´"  style="left:65%; top:30%; display:none;">V</div>
                  <div class="mark" id="a_mark_íƒ€ì´ì–´" style="left:45%; top:75%; display:none;">V</div>
                  <div class="mark" id="a_mark_íŠ¸ë í¬" style="left:80%; top:35%; display:none;">V</div>
                </div>

                <!-- print.html í˜¸í™˜ìš© hidden: ì²´í¬ëœ ìˆœì„œëŒ€ë¡œ a_view_1..5 / a_x_1..5 / a_y_1..5 ì±„ì›€ -->
                <input type="hidden" name="a_view_1"><input type="hidden" name="a_x_1"><input type="hidden" name="a_y_1">
                <input type="hidden" name="a_view_2"><input type="hidden" name="a_x_2"><input type="hidden" name="a_y_2">
                <input type="hidden" name="a_view_3"><input type="hidden" name="a_x_3"><input type="hidden" name="a_y_3">
                <input type="hidden" name="a_view_4"><input type="hidden" name="a_x_4"><input type="hidden" name="a_y_4">
                <input type="hidden" name="a_view_5"><input type="hidden" name="a_x_5"><input type="hidden" name="a_y_5">
              </div>

              <div style="border-top:var(--line) solid #000;">
                <div class="cell hdr" style="border-bottom:0;">[êµ¬ì²´ì  íŒŒì†ì •ë„ ë° íŠ¹ì´ì‚¬í•­ ê¸°ìˆ ]</div>
                <div class="desc-area"><textarea name="a_damage_desc" style="height:100%"></textarea></div>
              </div>
            </div>

            <!-- B ì°¨ëŸ‰ -->
            <div style="border-right:var(--line) solid #000;">
              <div class="section-title">B ì°¨ëŸ‰</div>
              <div class="grid two-col">
                <div class="cell hdr">ì°¨ëŸ‰ë²ˆí˜¸</div>
                <div class="cell"><input name="b_plate" placeholder="ì˜ˆ: 34ë‚˜5678" required /></div>
                <div class="cell hdr">ë³´í—˜ì‚¬</div>
                <div class="cell">
                  <select name="b_insurer" required>
                    <option value="">ë³´í—˜ì‚¬ ì„ íƒ</option>
                    <option value="ë©”ë¦¬ì¸ í™”ì¬">ë©”ë¦¬ì¸ í™”ì¬</option>
                    <option value="í•œí™”ì†í•´ë³´í—˜">í•œí™”ì†í•´ë³´í—˜</option>
                    <option value="ë¡¯ë°ì†í•´ë³´í—˜">ë¡¯ë°ì†í•´ë³´í—˜</option>
                    <option value="MGì†í•´ë³´í—˜">MGì†í•´ë³´í—˜</option>
                    <option value="í¥êµ­í™”ì¬">í¥êµ­í™”ì¬</option>
                    <option value="ì‚¼ì„±í™”ì¬">ì‚¼ì„±í™”ì¬</option>
                    <option value="AXAì†í•´ë³´í—˜">AXAì†í•´ë³´í—˜</option>
                    <option value="í˜„ëŒ€í•´ìƒ">í˜„ëŒ€í•´ìƒ</option>
                    <option value="DBì†í•´ë³´í—˜">DBì†í•´ë³´í—˜</option>
                    <option value="AXAì†í•´ë³´í—˜">AXAì†í•´ë³´í—˜</option>
                    <option value="í•˜ë‚˜ì†í•´ë³´í—˜">í•˜ë‚˜ì†í•´ë³´í—˜</option>
                    <option value="ìºë¡¯ì†í•´ë³´í—˜">ìºë¡¯ì†í•´ë³´í—˜</option>
                  </select>
                  </select>
                </div>
              </div>
              <div class="grid two-col">
                <div class="cell hdr">ìš´ì „ì<br/>ì •ë³´</div><div class="cell tight"></div>
                <div class="cell hdr">ì„± ëª…</div>
                <div class="cell"><input name="b_name" placeholder="ì˜ˆ: ê¹€ì² ìˆ˜" pattern="[ê°€-í£]{2,5}" title="í•œê¸€ 2-5ê¸€ìë¡œ ì…ë ¥í•˜ì„¸ìš”" required /></div>
                <div class="cell hdr">ì£¼ë¯¼ë²ˆí˜¸</div>
                <div class="cell"><input name="b_id" placeholder="ì˜ˆ: 750505-1******" pattern="[0-9]{6}-[0-9]{7}" title="ì£¼ë¯¼ë²ˆí˜¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”" required /></div>
                <div class="cell hdr">ì „í™”ë²ˆí˜¸<br/><small>(íœ´ëŒ€í°ë²ˆí˜¸)</small></div>
                <div class="cell"><input name="b_phone" placeholder="ì˜ˆ: 010-9876-5432" pattern="010-[0-9]{4}-[0-9]{4}" title="010-0000-0000 í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”" required /></div>
                <div class="cell hdr">ì£¼ ì†Œ</div>
                <div class="cell"><input name="b_address" placeholder="ì˜ˆ: ê²½ê¸° ì„±ë‚¨ì‹œ..." required /></div>
              </div>
              <div class="grid two-col">
                <div class="cell hdr">íƒ‘ìŠ¹ì¸ì›<br/><span style="font-weight:400;">(ìš´ì „ìì œì™¸)</span></div>
                <div class="cell">
                  <div style="display:flex; gap:8px; align-items:center;">
                    ë‚¨ <input type="number" min="0" value="0" id="b_male" style="width:70px" required />
                    ì—¬ <input type="number" min="0" value="0" id="b_female" style="width:70px" required />
                    <span style="flex:1"></span><b>í•©ê³„</b> <span id="b_total">0</span>ëª…
                  </div>
                </div>
              </div>

              <div class="damage-wrap">
                <div class="damage-head">[íŒŒì†ë¶€ìœ„] : í•´ë‹¹ ë¶€ìœ„ì— V í‘œì‹œ</div>

                <!-- ì²´í¬ë°•ìŠ¤: ì „ë©´/í›„ë©´/íƒ€ì´ì–´/íŠ¸ë í¬ -->
                {% comment %} <div class="weather-row" style="margin-bottom:6px;">
                  <label><input type="checkbox" name="b_mark" value="ì „ë©´"  data-target="b" /> ì „ë©´</label>
                  <label><input type="checkbox" name="b_mark" value="í›„ë©´"  data-target="b" /> í›„ë©´</label>
                  <label><input type="checkbox" name="b_mark" value="íƒ€ì´ì–´" data-target="b" /> íƒ€ì´ì–´</label>
                  <label><input type="checkbox" name="b_mark" value="íŠ¸ë í¬" data-target="b" /> íŠ¸ë í¬</label>
                </div> {% endcomment %}
                <!-- ìƒˆë¡œìš´ ì»¨íŠ¸ë¡¤ ì˜ì—­ -->
                <!-- ìƒˆë¡œìš´ ì»¨íŠ¸ë¡¤ ì˜ì—­ -->
                <div class="damage-controls">
                  <p class="instruction">
                    ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ì—¬ íŒŒì†ë¶€ìœ„ë¥¼ í‘œì‹œí•˜ì„¸ìš” 
                    <span class="mark-counter" id="a_counter">(0/5)</span>
                  </p>
                  <div class="control-buttons">
                    <button type="button" class="btn-reset" onclick="resetMarks('b')">ì²´í¬ ì´ˆê¸°í™”</button>
                    <button type="button" class="btn-undo" onclick="undoLastMark('b')">ì´ì „ ì²´í¬ ì‚­ì œ</button>
                  </div>
                </div>

                <div class="damage-img-box" id="b_imgbox">
                  <img src="{% static 'images/damage_outline.png' %}" alt="Bì°¨ëŸ‰ íŒŒì†ë¶€ìœ„ ë„ë©´" />
                  <!-- ë§ˆí‚¹ ì˜¤ë²„ë ˆì´ -->
                  <div class="mark" id="b_mark_ì „ë©´"  style="left:35%; top:25%; display:none;">V</div>
                  <div class="mark" id="b_mark_í›„ë©´"  style="left:65%; top:30%; display:none;">V</div>
                  <div class="mark" id="b_mark_íƒ€ì´ì–´" style="left:45%; top:75%; display:none;">V</div>
                  <div class="mark" id="b_mark_íŠ¸ë í¬" style="left:80%; top:35%; display:none;">V</div>
                </div>

                <!-- print.html í˜¸í™˜ìš© hidden -->
                <input type="hidden" name="b_view_1"><input type="hidden" name="b_x_1"><input type="hidden" name="b_y_1">
                <input type="hidden" name="b_view_2"><input type="hidden" name="b_x_2"><input type="hidden" name="b_y_2">
                <input type="hidden" name="b_view_3"><input type="hidden" name="b_x_3"><input type="hidden" name="b_y_3">
                <input type="hidden" name="b_view_4"><input type="hidden" name="b_x_4"><input type="hidden" name="b_y_4">
                <input type="hidden" name="b_view_5"><input type="hidden" name="b_x_5"><input type="hidden" name="b_y_5">
              </div>

              <div style="border-top:var(--line) solid #000;">
                <div class="cell hdr" style="border-bottom:0;">[êµ¬ì²´ì  íŒŒì†ì •ë„ ë° íŠ¹ì´ì‚¬í•­ ê¸°ìˆ ]</div>
                <div class="desc-area"><textarea name="b_damage_desc" style="height:100%"></textarea></div>
              </div>
            </div>

            <!-- ë³´í–‰ì -->
            <div>
              <div class="section-title">ë³´í–‰ì</div>
              <div class="grid two-col">
                <div class="cell hdr">ì„±ëª…:</div>
                <div class="cell"><input name="p_name" placeholder="ì˜ˆ: ì´ì˜í¬" pattern="[ê°€-í£]{2,5}" title="í•œê¸€ 2-5ê¸€ìë¡œ ì…ë ¥í•˜ì„¸ìš”" /></div>
                <div class="cell hdr">ì£¼ë¯¼ë²ˆí˜¸:</div>
                <div class="cell"><input name="p_id" placeholder="ì˜ˆ: 850315-2******" pattern="[0-9]{6}-[0-9]{7}" title="ì£¼ë¯¼ë²ˆí˜¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”" /></div>
                <div class="cell hdr">ì „í™”ë²ˆí˜¸:</div>
                <div class="cell"><input name="p_phone" placeholder="ì˜ˆ: 010-5555-6666" pattern="010-[0-9]{4}-[0-9]{4}" title="010-0000-0000 í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”" /></div>
                <div class="cell hdr">ì£¼ì†Œ:</div>
                <div class="cell"><input name="p_address" placeholder="ì˜ˆ: ì¸ì²œ ë¶€í‰êµ¬..." /></div>
              </div>
              <div style="border-top:var(--line) solid #000;">
                <div class="cell hdr" style="border-bottom:0;">[êµ¬ì²´ì  í”¼í•´ì •ë„ ë° íŠ¹ì´ì‚¬í•­ ê¸°ìˆ ]</div>
                <div class="desc-area" style="height:392px;"><textarea name="p_damage_desc" style="height:100%" placeholder="ì˜ˆ: ìš°ì¸¡ ë¬´ë¦ íƒ€ë°•ìƒ, ì°°ê³¼ìƒ ë“±"></textarea></div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- ì‚¬ê³ ë‚´ìš©/ì‚¬ê³ ì•½ë„ (í‘œ 4ë¸”ë¡ êµ¬ì„±) -->
    <div class="box" style="border-top:0;">
      <div class="row" style="align-items:stretch;">
        <div class="title-v">ì‚¬ê³ ë‚´ìš©</div>
        <div style="flex:1;" class="acc-wrap">
          <!-- ì¢Œ: ë‚´ìš©(í‘œ) -->
          <div class="acc-left">
            <table class="acc">
              <!-- 1Â·2 í†µí•©: ì‚¬ê³ í˜•íƒœ -->
              <tr>
                <th style="width:110px;">ì‚¬ê³ í˜•íƒœ</th>
                <td>
                  <div class="label">ìë™ì°¨ëŒ€ ìë™ì°¨</div>
                  <div class="weather-row" style="margin:4px 0;">
                    <label><input type="checkbox" name="type_cc" value="ì •ë©´ì¶©ëŒ"> ì •ë©´ì¶©ëŒ</label>
                    <label><input type="checkbox" name="type_cc" value="í›„ë¯¸ì¶”ëŒ(ì§„í–‰ì¤‘)"> í›„ë¯¸ì¶”ëŒ(ì§„í–‰ì¤‘)</label>
                    <label><input type="checkbox" name="type_cc" value="í›„ë¯¸ì¶”ëŒ(ì£¼ì •ì°¨ì¤‘)"> í›„ë¯¸ì¶”ëŒ(ì£¼ì •ì°¨ì¤‘)</label>
                    <label><input type="checkbox" name="type_cc" value="ì¸¡ë©´ì¶©ëŒ"> ì¸¡ë©´ì¶©ëŒ</label>
                    <label><input type="checkbox" name="type_cc" value="í›„ì§„ì‚¬ê³ "> í›„ì§„ì‚¬ê³ </label>
                  </div>
                  <div class="label" style="margin-top:4px;">ìë™ì°¨ëŒ€ ë³´í–‰ì</div>
                  <div class="weather-row" style="margin:4px 0;">
                    <label><input type="checkbox" name="type_cp" value="íš¡ë‹¨ë³´ë„ í†µí–‰ì¤‘"> íš¡ë‹¨ë³´ë„ í†µí–‰ì¤‘</label>
                    <label><input type="checkbox" name="type_cp" value="ë¬´ë‹¨íš¡ë‹¨ì¤‘"> ë¬´ë‹¨íš¡ë‹¨ì¤‘</label>
                    <label><input type="checkbox" name="type_cp" value="ì°¨ë„ê°€ì¥ìë¦¬ í†µí–‰ì¤‘"> ì°¨ë„ê°€ì¥ìë¦¬ í†µí–‰ì¤‘</label>
                    <label><input type="checkbox" name="type_cp" value="ë³´ë„ í†µí–‰ì¤‘"> ë³´ë„ í†µí–‰ì¤‘</label>
                  </div>
                </td>
              </tr>
              <!-- 3: ì‚¬ê³ ì›ì¸ -->
              <tr>
                <th>ì‚¬ê³ ì›ì¸</th>
                <td>
                  <div class="weather-row">
                    <label><input type="checkbox" name="cause" value="ìŒì£¼/ì£¼ì·¨ìš´ì „"> ìŒì£¼Â·ì£¼ì·¨ìš´ì „</label>
                    <label><input type="checkbox" name="cause" value="ì‹ í˜¸ìœ„ë°˜"> ì‹ í˜¸ìœ„ë°˜</label>
                    <label><input type="checkbox" name="cause" value="ì¤‘ì•™ì„ ì¹¨ë²”"> ì¤‘ì•™ì„ ì¹¨ë²”</label>
                    <label><input type="checkbox" name="cause" value="ì†ë„ìœ„ë°˜"> ì†ë„ìœ„ë°˜</label>
                    <label><input type="checkbox" name="cause" value="íš¡ë‹¨ë³´ë„ìœ„ë°˜"> íš¡ë‹¨ë³´ë„ìœ„ë°˜</label>
                    <label><input type="checkbox" name="cause" value="ê¸°íƒ€"> ê¸°íƒ€</label>
                  </div>
                </td>
              </tr>
              <!-- 4: ìƒì„¸ê¸°ìˆ  -->
              <tr>
                <th>[êµ¬ì²´ì  ì‚¬ê³  ê°œìš” ë° íŠ¹ì´ì‚¬í•­]</th>
                <td><textarea name="accident_description" rows="6" style="border:0; width:100%;"></textarea></td>
              </tr>
            </table>
          </div>

          <!-- ìš°: ì‚¬ê³ ì•½ë„(í°ì¹¸) -->
          <div class="acc-right">
            <div class="tag">[ì‚¬ê³ ì•½ë„]</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ë³´í—˜ì²­êµ¬ -->
    <div class="box" style="border-top:0;">
      <div class="row">
        <div class="title-v">ë³´í—˜ì²­êµ¬</div>
        <div style="flex:1; padding:8px;">
          ìœ„ ê¸°ì¬ì‚¬í•­ì´ ì‚¬ì‹¤ê³¼ ë‹¤ë¦„ì´ ì—†ìŒì„ í™•ì¸í•˜ê³ , ì‹ ì†í•œ ì‚¬ê³ ì²˜ë¦¬ ë° ë³´í—˜ê¸ˆ ì²­êµ¬ë¥¼ ìœ„í•˜ì—¬ ìƒí˜¸ ì„œëª…ë‚ ì¸í•©ë‹ˆë‹¤.
          <table class="sign-table" style="margin-top:8px;">
            <tr>
              <td>A ì°¨ëŸ‰ :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ì„œëª…)</td>
              <td>B ì°¨ëŸ‰ :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ì„œëª…)</td>
              <td>ë³´í–‰ì :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ì„œëª…)</td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (views.py: generate_report) -->
    <!-- ë‹¤ì‹œ ì›ë˜ëŒ€ë¡œ -->
    <div class="btns">
      <button type="submit" name="format" value="pdf">PDF ë‹¤ìš´ë¡œë“œ</button>
      <button type="submit" name="format" value="jpg">JPG ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </form>

  <script>
    {% comment %} function openPrintPage(format) {
      // í¼ ìœ íš¨ì„± ê²€ì‚¬ ë¨¼ì € ì‹¤í–‰
      if (!validateForm()) {
        return false;
      }
      
      // í¼ ë°ì´í„° ìˆ˜ì§‘
      const formData = new FormData(document.querySelector('form'));
      const params = new URLSearchParams();
      
      // ëª¨ë“  input, textarea, select ë°ì´í„° ìˆ˜ì§‘
      for (let [key, value] of formData.entries()) {
        if (value) {
          params.append(key, value);
        }
      }
      
      // ì²´í¬ë°•ìŠ¤ ë°ì´í„° ë³„ë„ ì²˜ë¦¬
      document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
        params.append(checkbox.name, checkbox.value);
      });
      
      // íŒŒì†ë¶€ìœ„ ë§ˆí‚¹ ë°ì´í„° ì¶”ê°€
      ['a', 'b'].forEach(prefix => {
        if (window.damageMarks && window.damageMarks[prefix]) {
          window.damageMarks[prefix].forEach((mark, index) => {
            if (index < 5) {
              params.append(`${prefix}_view_${index + 1}`, `ì§ì ‘í‘œì‹œ_${index + 1}`);
              params.append(`${prefix}_x_${index + 1}`, Math.round(mark.x));
              params.append(`${prefix}_y_${index + 1}`, Math.round(mark.y));
            }
          });
        }
      });
      
      // í¬ë§· ì •ë³´ ì¶”ê°€
      params.append('format', format);
      
      // print.html í˜ì´ì§€ë¥¼ ìƒˆ ì°½ì—ì„œ ì—´ê¸°
      const printUrl = `print.html?${params.toString()}`;
      const printWindow = window.open(printUrl, '_blank', 'width=1200,height=800');
      
      // ìƒˆ ì°½ì´ ë¡œë“œëœ í›„ ìë™ìœ¼ë¡œ ì¸ì‡„ ëŒ€í™”ìƒì ì—´ê¸° (ì„ íƒì‚¬í•­)
      if (format === 'pdf') {
        printWindow.onload = function() {
          setTimeout(() => {
            printWindow.print();
          }, 1000);
        };
      }
    } {% endcomment %}



    // ===== í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì‹œìŠ¤í…œ =====
    // í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ìƒì„± (í•œ ë²ˆë§Œ)
    function createToastContainer() {
        if (document.querySelector('.toast-container')) return;
        
        const container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
    }

    /**
    * í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
    * @param {string} message - í‘œì‹œí•  ë©”ì‹œì§€
    * @param {string} type - 'error', 'success', 'info'
    * @param {number} duration - í‘œì‹œ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
    */
    function showToast(message, type = 'info', duration = 3000) {
        createToastContainer();
        
        const container = document.querySelector('.toast-container');
        const toast = document.createElement('div');
        
        const icons = {
            error: 'âš ï¸',
            success: 'âœ…', 
            info: 'â„¹ï¸'
        };
        
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <span class="toast-icon">${icons[type]}</span>
            <span class="toast-message">${message}</span>
            <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
        `;
        
        container.appendChild(toast);
        
        // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        setTimeout(() => toast.classList.add('show'), 10);
        
        // ìë™ ì œê±°
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    /**
    * ì´ë¯¸ì§€ ì˜ì—­ ë‚´ë¶€ í´ë¦­ í™•ì¸
    */
    function isClickOnImage(imgBox, clientX, clientY) {
        const img = imgBox.querySelector('img');
        if (!img) return false;
        
        const imgRect = img.getBoundingClientRect();
        
        // ì´ë¯¸ì§€ ê²½ê³„ì—ì„œ ì•½ê°„ì˜ ì—¬ìœ  ê³µê°„ (5px)
        const margin = 5;
        
        return (
            clientX >= imgRect.left + margin && 
            clientX <= imgRect.right - margin && 
            clientY >= imgRect.top + margin && 
            clientY <= imgRect.bottom - margin
        );
    }


    // íƒ‘ìŠ¹ì¸ì› í•©ê³„ í‘œì‹œ
    function bindPassengerCalc(prefix){
      const male=document.getElementById(prefix+'_male');
      const female=document.getElementById(prefix+'_female');
      const total=document.getElementById(prefix+'_total');
      const update=()=>{
        const m=parseInt(male?.value||'0',10);
        const f=parseInt(female?.value||'0',10);
        if(total) total.textContent=(m+f).toString();
      };
      male?.addEventListener('input',update);
      female?.addEventListener('input',update);
      update();
    }
    bindPassengerCalc('a');
    bindPassengerCalc('b');

    /**
     * íŒŒì† ì²´í¬ë°•ìŠ¤ â†’ ì˜¤ë²„ë ˆì´ V í‘œì‹œ + hidden ì¢Œí‘œ ì±„ìš°ê¸°
     * - viewOrder: ì „ë©´/í›„ë©´/íƒ€ì´ì–´/íŠ¸ë í¬ ì¤‘ ì²´í¬ëœ ìˆœì„œëŒ€ë¡œ a_view_1..3 ë¥¼ ì±„ì›€(ìµœëŒ€ 3ê°œ)
     * - coords: ì„ì˜ ì¢Œí‘œ(%) â€” ì´ë¯¸ì§€ì— ë§ì¶° ì•„ë˜ ê°’ë§Œ ìˆ˜ì •í•˜ë©´ ë¨
     */
    const COORDS = {
      ì „ë©´:  { x: 35, y: 25 },
      í›„ë©´:  { x: 65, y: 30 },
      íƒ€ì´ì–´:{ x: 45, y: 75 },
      íŠ¸ë í¬:{ x: 80, y: 35 },
    };

    function setupDamageMarking(prefix){
      // ì²´í¬ë°•ìŠ¤ NodeList
      const boxes = document.querySelectorAll(`input[name="${prefix}_mark"]`);
      // ì˜¤ë²„ë ˆì´ DOM
      const marks = {
        ì „ë©´:   document.getElementById(`${prefix}_mark_ì „ë©´`),
        í›„ë©´:   document.getElementById(`${prefix}_mark_í›„ë©´`),
        íƒ€ì´ì–´: document.getElementById(`${prefix}_mark_íƒ€ì´ì–´`),
        íŠ¸ë í¬: document.getElementById(`${prefix}_mark_íŠ¸ë í¬`),
      };
      // hidden inputs (print.html í˜¸í™˜)
      const h_view = [
        document.querySelector(`input[name="${prefix}_view_1"]`),
        document.querySelector(`input[name="${prefix}_view_2"]`),
        document.querySelector(`input[name="${prefix}_view_3"]`),
      ];
      const h_x = [
        document.querySelector(`input[name="${prefix}_x_1"]`),
        document.querySelector(`input[name="${prefix}_x_2"]`),
        document.querySelector(`input[name="${prefix}_x_3"]`),
      ];
      const h_y = [
        document.querySelector(`input[name="${prefix}_y_1"]`),
        document.querySelector(`input[name="${prefix}_y_2"]`),
        document.querySelector(`input[name="${prefix}_y_3"]`),
      ];

      function refresh(){
        // 1) ì˜¤ë²„ë ˆì´ í‘œì‹œ/ìˆ¨ê¹€
        boxes.forEach(box=>{
          const key = box.value;
          const el = marks[key];
          if(!el) return;
          if(box.checked){
            const {x,y} = COORDS[key] || {x:50,y:50};
            el.style.left = x + '%';
            el.style.top  = y + '%';
            el.style.display = '';
          }else{
            el.style.display = 'none';
          }
        });

        // 2) hidden ê°±ì‹  (ì²´í¬ëœ ìˆœì„œëŒ€ë¡œ ìµœëŒ€ 3ê°œ)
        const checked = Array.from(boxes).filter(b=>b.checked).map(b=>b.value).slice(0,3);
        for(let i=0;i<3;i++){
          if(checked[i]){
            const key = checked[i];
            h_view[i].value = key;
            const {x,y} = COORDS[key] || {x:50,y:50};
            h_x[i].value = x;
            h_y[i].value = y;
          }else{
            h_view[i].value = '';
            h_x[i].value = '';
            h_y[i].value = '';
          }
        }
      }

      boxes.forEach(b=> b.addEventListener('change', refresh));
      refresh(); // ì´ˆê¸°í™”
    }

    {% comment %} setupDamageMarking('a');
    setupDamageMarking('b'); {% endcomment %}

    // ===== ìƒˆë¡œìš´ ì§ì ‘ í´ë¦­ ì‹œìŠ¤í…œ (Phase 4) =====
    // ì „ì—­ ë³€ìˆ˜
    const damageMarks = { a: [], b: [] };  // ê° ì°¨ëŸ‰ë³„ ë§ˆí‚¹ ë°ì´í„°
    const markCounters = { a: 0, b: 0 };   // ë§ˆí¬ ID ì¹´ìš´í„°
    const MAX_MARKS = 5;                   // ìµœëŒ€ ë§ˆí‚¹ ê°œìˆ˜

    /**
    * ì§ì ‘ í´ë¦­ìœ¼ë¡œ ë§ˆí‚¹í•˜ëŠ” ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    */
    function setupDirectClicking(prefix) {
        const imgBox = document.getElementById(`${prefix}_imgbox`);
        if (!imgBox) return;
        
        // í´ë¦­/í„°ì¹˜ ì²˜ë¦¬ í•¨ìˆ˜
        function handleImageClick(e) {
            // ì´ë¯¸ì§€ ì˜ì—­ ì²´í¬
            if (!isClickOnImage(imgBox, e.clientX, e.clientY)) {
                showToast('ì°¨ëŸ‰ ì´ë¯¸ì§€ ìœ„ì— íŒŒì†ë¶€ìœ„ë¥¼ í‘œì‹œí•´ì£¼ì„¸ìš”!', 'error', 2500);
                return;
            }
            
            // ìµœëŒ€ ê°œìˆ˜ í™•ì¸
            if (damageMarks[prefix].length >= MAX_MARKS) {
                showToast(`ìµœëŒ€ ${MAX_MARKS}ê°œê¹Œì§€ë§Œ í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`, 'error', 2500);
                return;
            }
            
            // í´ë¦­ ìœ„ì¹˜ ê³„ì‚° (ì´ë¯¸ì§€ ê¸°ì¤€)
            const img = imgBox.querySelector('img');
            const imgRect = img.getBoundingClientRect();
            const x = ((e.clientX - imgRect.left) / imgRect.width) * 100;
            const y = ((e.clientY - imgRect.top) / imgRect.height) * 100;
            
            // ë§ˆí¬ ìƒì„±
            createDamageMark(prefix, imgBox, x, y);
            
            // ë°ì´í„° ì €ì¥
            const markId = `${prefix}_mark_${++markCounters[prefix]}`;
            damageMarks[prefix].push({ x, y, id: markId });
            
            // hidden input ì—…ë°ì´íŠ¸
            updateHiddenInputs(prefix);
            // ì¹´ìš´í„° ì—…ë°ì´íŠ¸ (ì—¬ê¸°ë¡œ ì´ë™)
            updateMarkCounter(prefix);
            
            // ì„±ê³µ í† ìŠ¤íŠ¸
            showToast('íŒŒì†ë¶€ìœ„ê°€ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success', 1500);
            
            console.log(`${prefix.toUpperCase()}ì°¨ëŸ‰ ë§ˆí‚¹:`, damageMarks[prefix]);
        }
        
        // ì´ë²¤íŠ¸ ë“±ë¡
        imgBox.addEventListener('click', handleImageClick);
        
        // ëª¨ë°”ì¼ í„°ì¹˜ ì§€ì›
        imgBox.addEventListener('touchend', function(e) {
            e.preventDefault();
            const touch = e.changedTouches[0];
            handleImageClick({ clientX: touch.clientX, clientY: touch.clientY });
        });

    }

    /**
    * V ë§ˆí¬ DOM ìš”ì†Œ ìƒì„±
    */
    function createDamageMark(prefix, container, x, y) {
        const mark = document.createElement('div');
        mark.className = 'damage-mark';
        mark.id = `${prefix}_mark_${markCounters[prefix] + 1}`;
        
        // ğŸ‘‡ imgBox ê¸°ì¤€ìœ¼ë¡œ ì ˆëŒ€ ìœ„ì¹˜ ê³„ì‚°
        const img = container.querySelector('img');
        const imgRect = img.getBoundingClientRect();
        const boxRect = container.getBoundingClientRect();
        
        // ì´ë¯¸ì§€ ë‚´ ìƒëŒ€ ì¢Œí‘œë¥¼ imgBox ë‚´ ì ˆëŒ€ ì¢Œí‘œë¡œ ë³€í™˜
        const actualX = ((imgRect.left - boxRect.left) / boxRect.width * 100) + 
                        (x / 100 * imgRect.width / boxRect.width * 100);
        const actualY = ((imgRect.top - boxRect.top) / boxRect.height * 100) + 
                        (y / 100 * imgRect.height / boxRect.height * 100);
        
        mark.style.left = actualX + '%';
        mark.style.top = actualY + '%';
        mark.textContent = 'V';
                
        // ë§ˆí¬ í´ë¦­ì‹œ í•´ë‹¹ ë§ˆí¬ë§Œ ì‚­ì œ (ì„ íƒì‚¬í•­)
        mark.addEventListener('click', function(e) {
            e.stopPropagation(); // ë¶€ëª¨ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
            
            if (confirm('ì´ ë§ˆí¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ë°ì´í„°ì—ì„œ ì œê±°
                const markIndex = damageMarks[prefix].findIndex(m => m.id === mark.id);
                if (markIndex > -1) {
                    damageMarks[prefix].splice(markIndex, 1);
                }
                
                // DOMì—ì„œ ì œê±°
                mark.remove();
                
                // hidden input ì—…ë°ì´íŠ¸
                updateHiddenInputs(prefix);
                updateMarkCounter(prefix);  // â† ì´ ì¤„ë§Œ ì¶”ê°€
                
                console.log(`${prefix.toUpperCase()}ì°¨ëŸ‰ ë§ˆí¬ ì‚­ì œ:`, damageMarks[prefix]);
            }
        });
        
        container.appendChild(mark);
        updateMarkCounter(prefix);  // â† ì´ ì¤„ë§Œ ì¶”ê°€
    }

    /**
    * hidden input í•„ë“œ ì—…ë°ì´íŠ¸ (PDF/JPG ìƒì„±ìš©)
    */
    function updateHiddenInputs(prefix) {
        // ê¸°ì¡´ hidden input ì´ˆê¸°í™”
        for (let i = 1; i <= 5; i++) {
            const viewInput = document.querySelector(`input[name="${prefix}_view_${i}"]`);
            const xInput = document.querySelector(`input[name="${prefix}_x_${i}"]`);
            const yInput = document.querySelector(`input[name="${prefix}_y_${i}"]`);
            
            if (viewInput) viewInput.value = '';
            if (xInput) xInput.value = '';
            if (yInput) yInput.value = '';
        }
        
        // í˜„ì¬ ë§ˆí¬ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
        damageMarks[prefix].forEach((mark, index) => {
            if (index < 5) { // ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ
                const viewInput = document.querySelector(`input[name="${prefix}_view_${index + 1}"]`);
                const xInput = document.querySelector(`input[name="${prefix}_x_${index + 1}"]`);
                const yInput = document.querySelector(`input[name="${prefix}_y_${index + 1}"]`);
                
                if (viewInput) viewInput.value = `ì§ì ‘í‘œì‹œ_${index + 1}`;
                if (xInput) xInput.value = Math.round(mark.x);
                if (yInput) yInput.value = Math.round(mark.y);
            }
        });
    }

    /**
    * ì²´í¬ ì´ˆê¸°í™” ë²„íŠ¼ ê¸°ëŠ¥ (ê°œì„ ëœ ë²„ì „)
    */
    function resetMarks(prefix) {
        if (damageMarks[prefix].length === 0) {
            showToast('ì‚­ì œí•  ë§ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info', 2000);
            return;
        }
        
        // í™•ì¸ ë©”ì‹œì§€
        if (!confirm(`${prefix.toUpperCase()}ì°¨ëŸ‰ì˜ ëª¨ë“  ë§ˆí‚¹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }
        
        // ëª¨ë“  ë§ˆí¬ DOM ì œê±°
        const imgBox = document.getElementById(`${prefix}_imgbox`);
        if (imgBox) {
            imgBox.querySelectorAll('.damage-mark').forEach(mark => mark.remove());
        }
        
        // ë°ì´í„° ì´ˆê¸°í™”
        const deletedCount = damageMarks[prefix].length;
        damageMarks[prefix] = [];
        markCounters[prefix] = 0;
        
        // hidden input ì´ˆê¸°í™”
        updateHiddenInputs(prefix);
        updateMarkCounter(prefix);  // â† ì´ ì¤„ë§Œ ì¶”ê°€
        
        showToast(`${deletedCount}ê°œì˜ ë§ˆí‚¹ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success', 2000);
        console.log(`${prefix.toUpperCase()}ì°¨ëŸ‰ ì „ì²´ ì´ˆê¸°í™”`);
    }
    
    /**
    * ì´ì „ ì²´í¬ ì‚­ì œ ë²„íŠ¼ ê¸°ëŠ¥ (ê°œì„ ëœ ë²„ì „)
    */
    function undoLastMark(prefix) {
        if (damageMarks[prefix].length === 0) {
            showToast('ì‚­ì œí•  ë§ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info', 2000);
            return;
        }
        
        // ë§ˆì§€ë§‰ ë§ˆí¬ ë°ì´í„° ì œê±°
        const lastMark = damageMarks[prefix].pop();
        
        // ë§ˆì§€ë§‰ ë§ˆí¬ DOM ì œê±°
        const lastMarkElement = document.getElementById(lastMark.id);
        if (lastMarkElement) {
            lastMarkElement.remove();
        }
        
        // hidden input ì—…ë°ì´íŠ¸
        updateHiddenInputs(prefix);
        updateMarkCounter(prefix);  // â† ì´ ì¤„ë§Œ ì¶”ê°€
        
        showToast('ë§ˆì§€ë§‰ ë§ˆí‚¹ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success', 1500);
        console.log(`${prefix.toUpperCase()}ì°¨ëŸ‰ ë§ˆì§€ë§‰ ë§ˆí¬ ì‚­ì œ:`, damageMarks[prefix]);
    }

    // ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    setupDirectClicking('a');
    setupDirectClicking('b');

    console.log('ìƒˆë¡œìš´ ì§ì ‘ í´ë¦­ ì‹œìŠ¤í…œì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');

    /**
    * ë§ˆí‚¹ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
    */
    function updateMarkCounter(prefix) {
        const counter = document.getElementById(`${prefix}_counter`);
        if (counter) {
            const count = damageMarks[prefix].length;
            counter.textContent = `(${count}/${MAX_MARKS})`;
            
            // ìƒ‰ìƒ ë³€ê²½
            if (count === 0) {
                counter.style.color = '#999';
            } else if (count >= MAX_MARKS) {
                counter.style.color = '#e74c3c';
            } else {
                counter.style.color = '#3498db';
            }
        }
    }
    // ===== ìœ íš¨ì„± ê²€ì‚¬ ì‹œìŠ¤í…œ =====
    /**
    * ì°¨ëŸ‰ ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
    */
    function validateVehicleData(prefix, vehicleName) {
        const requiredFields = [
            { name: `${prefix}_plate`, label: 'ì°¨ëŸ‰ë²ˆí˜¸' },
            { name: `${prefix}_insurer`, label: 'ë³´í—˜ì‚¬' },
            { name: `${prefix}_name`, label: 'ì„±ëª…' },
            { name: `${prefix}_id`, label: 'ì£¼ë¯¼ë²ˆí˜¸' },
            { name: `${prefix}_phone`, label: 'ì „í™”ë²ˆí˜¸' },
            { name: `${prefix}_address`, label: 'ì£¼ì†Œ' }
        ];
        
        for (let field of requiredFields) {
            const element = document.querySelector(`[name="${field.name}"]`);
            if (!element || !element.value.trim()) {
                showToast(`${vehicleName} ${field.label}ì„(ë¥¼) ì…ë ¥í•´ì£¼ì„¸ìš”.`, 'error', 3000);
                element?.focus();
                return false;
            }
        }
        
        // íƒ‘ìŠ¹ì¸ì› ê²€ì‚¬
        const male = document.getElementById(`${prefix}_male`);
        const female = document.getElementById(`${prefix}_female`);
        if (male.value === '' || female.value === '') {
            showToast(`${vehicleName} íƒ‘ìŠ¹ì¸ì›ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`, 'error', 3000);
            male.focus();
            return false;
        }
        
        return true;
    }

    /**
    * ë³´í–‰ì ì¡°ê±´ë¶€ ìœ íš¨ì„± ê²€ì‚¬
    */
    function validatePedestrianData() {
        const pedestrianFields = [
            { name: 'p_name', label: 'ì„±ëª…' },
            { name: 'p_id', label: 'ì£¼ë¯¼ë²ˆí˜¸' },
            { name: 'p_phone', label: 'ì „í™”ë²ˆí˜¸' },
            { name: 'p_address', label: 'ì£¼ì†Œ' }
        ];
        
        const filledFields = pedestrianFields.filter(field => 
            document.querySelector(`[name="${field.name}"]`)?.value.trim() !== ''
        );
        
        // í•˜ë‚˜ë¼ë„ ì…ë ¥í–ˆìœ¼ë©´ ì „ì²´ í•„ìˆ˜
        if (filledFields.length > 0 && filledFields.length < pedestrianFields.length) {
            const emptyFields = pedestrianFields
                .filter(field => !document.querySelector(`[name="${field.name}"]`)?.value.trim())
                .map(field => field.label);
            
            showToast(`ë³´í–‰ì ì •ë³´ë¥¼ ì…ë ¥í•˜ì…¨ë‹¤ë©´ ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\në¯¸ì…ë ¥: ${emptyFields.join(', ')}`, 'error', 4000);
            return false;
        }
        
        return true;
    }

    /**
    * íŒŒì†ë¶€ìœ„ ë§ˆí‚¹ ê²€ì‚¬
    */
    function validateDamageMarks() {
        if (damageMarks.a.length === 0) {
            showToast('Aì°¨ëŸ‰ì˜ íŒŒì†ë¶€ìœ„ë¥¼ í‘œì‹œí•´ì£¼ì„¸ìš”.', 'error', 3000);
            return false;
        }
        
        if (damageMarks.b.length === 0) {
            showToast('Bì°¨ëŸ‰ì˜ íŒŒì†ë¶€ìœ„ë¥¼ í‘œì‹œí•´ì£¼ì„¸ìš”.', 'error', 3000);
            return false;
        }
        
        return true;
    }

    /**
    * ì „ì²´ í¼ ìœ íš¨ì„± ê²€ì‚¬
    */
    function validateForm() {
        // 1. Aì°¨ëŸ‰ í•„ìˆ˜ í•­ëª© ê²€ì‚¬
        if (!validateVehicleData('a', 'Aì°¨ëŸ‰')) return false;
        
        // 2. Bì°¨ëŸ‰ í•„ìˆ˜ í•­ëª© ê²€ì‚¬  
        if (!validateVehicleData('b', 'Bì°¨ëŸ‰')) return false;
        
        // 3. ë³´í–‰ì ì¡°ê±´ë¶€ ê²€ì‚¬
        if (!validatePedestrianData()) return false;
        
        // 4. íŒŒì†ë¶€ìœ„ ë§ˆí‚¹ ê²€ì‚¬
        if (!validateDamageMarks()) return false;
        
        // ëª¨ë“  ê²€ì‚¬ í†µê³¼
        showToast('ëª¨ë“  í•­ëª©ì´ ì •ìƒì ìœ¼ë¡œ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success', 2000);
        return true;
    }

    // ===== í¼ ì œì¶œ ì´ë²¤íŠ¸ ì²˜ë¦¬ =====
    /**
    * í¼ ì œì¶œ ì „ ìœ íš¨ì„± ê²€ì‚¬
    */
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                // ìœ íš¨ì„± ê²€ì‚¬ ì‹¤í–‰
                if (!validateForm()) {
                    e.preventDefault(); // í¼ ì œì¶œ ì¤‘ë‹¨
                    return false;
                }
                
                // ê²€ì‚¬ í†µê³¼ì‹œ ì œì¶œ ì§„í–‰
                console.log('í¼ ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼ - ì œì¶œ ì§„í–‰');
            });
        }
    });
    
    /**
    * ì‹¤ì‹œê°„ ì…ë ¥ ê²€ì¦
    */
    function setupRealTimeValidation() {
        // í•„ìˆ˜ ì…ë ¥ í•­ëª©ë“¤ì— ì‹¤ì‹œê°„ ê²€ì¦ ì¶”ê°€
        const requiredInputs = document.querySelectorAll('input[required]');
        
        requiredInputs.forEach(input => {
            input.addEventListener('blur', function() {
                if (!this.value.trim()) {
                    this.style.borderColor = '#e74c3c';
                    this.style.backgroundColor = '#fdf2f2';
                } else {
                    this.style.borderColor = '#27ae60';
                    this.style.backgroundColor = '#f2fdf2';
                }
            });
            
            input.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.style.borderColor = '';
                    this.style.backgroundColor = '';
                }
            });
        });
    }

    // í˜ì´ì§€ ë¡œë“œì‹œ ì‹¤ì‹œê°„ ê²€ì¦ ì„¤ì •
    document.addEventListener('DOMContentLoaded', function() {
        setupRealTimeValidation();
    });

  </script>
</body>
</html>